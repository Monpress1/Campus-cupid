<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Campus Cupid ❤️ - Notifications</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Base Styles & Utilities */
        body {
            margin: 0;
            font-family: "Segoe UI", Arial, sans-serif;
            background: linear-gradient(135deg, #0f172a, #1e293b, #334155);
            color: #fff;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 1rem;
        }
        .container {
            width: 100%;
            max-width: 600px;
        }
        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            width: 100%;
            position: relative;
        }
        .navbar h1 {
            font-size: 1.5rem;
            margin: 0;
        }
        .navbar i {
            font-size: 1.5rem;
            cursor: pointer;
        }
        .menu-content {
            display: none;
            position: absolute;
            right: 0;
            top: 30px;
            background: rgba(30, 41, 59, 0.95);
            border-radius: 0.5rem;
            min-width: 150px;
            padding: 0.5rem;
            z-index: 100;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            animation: fadeIn 0.3s ease-in-out;
        }
        .menu-content a, .menu-content button {
            display: flex;
            align-items: center;
            gap: 0.8rem;
            width: 100%;
            padding: 0.7rem;
            background: none;
            border: none;
            color: #fff;
            text-align: left;
            cursor: pointer;
            border-radius: 0.4rem;
            text-decoration: none;
        }
        .menu-content a:hover, .menu-content button:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .page-title {
            text-align: center;
            margin-bottom: 1.5rem;
        }
        .notification-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .notification-item {
            display: flex;
            align-items: center;
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(10px);
            padding: 1rem;
            border-radius: 0.75rem;
            position: relative;
            animation: fadeInItem 0.5s ease-out;
            border-left: 4px solid transparent;
            transition: all 0.3s ease;
            cursor: pointer; /* Makes it look clickable */
        }
        .notification-item.unread {
            border-left: 4px solid #fbbf24;
        }
        .notification-item:hover {
            background: rgba(255, 255, 255, 0.12);
        }
        @keyframes fadeInItem {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .notification-content {
            flex-grow: 1;
            margin-right: 1rem;
        }
        .notification-content p {
            margin: 0;
            font-size: 1rem;
            word-wrap: break-word;
        }
        .notification-content small {
            color: #94a3b8;
            font-size: 0.8rem;
        }
        .notification-avatar {
            width: 60px; /* Adjust width for oval shape */
            height: 40px; /* Adjust height for oval shape */
            border-radius: 50% / 100%; /* Creates an oval shape */
            object-fit: cover;
            margin-right: 1rem;
            border: 2px solid #fbbf24;
        }
        .notification-avatar-placeholder {
            width: 60px;
            height: 40px;
            border-radius: 50% / 100%;
            background-color: #475569;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-right: 1rem;
            font-size: 1.5rem;
            color: #fff;
            border: 2px solid #fbbf24;
        }
        .notification-actions {
            display: flex;
            gap: 0.5rem;
            flex-shrink: 0;
        }
        .notification-actions button {
            background: #fbbf24;
            color: #1e293b;
            border: none;
            padding: 0.5rem 0.8rem;
            border-radius: 0.5rem;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.3s ease;
        }
        .notification-actions button.reject-btn {
            background: #ef4444;
            color: #fff;
        }
        .notification-actions button:hover {
            opacity: 0.8;
        }
        #noNotifications {
            text-align: center;
            color: #94a3b8;
            margin-top: 5rem;
            display: none;
        }
        /* Placeholder styling */
        .placeholder-notification {
            background: #334155;
            border-radius: 0.75rem;
            height: 70px;
            animation: pulse 1.5s infinite ease-in-out;
        }
        @keyframes pulse {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="navbar">
            <a href="feed.html"><i class="fa-solid fa-arrow-left"></i></a>
        </div>

        <h1>Notifications</h1>

        <div id="notificationList" class="notification-list">
            <div class="placeholder-notification"></div>
            <div class="placeholder-notification" style="width: 90%;"></div>
            <div class="placeholder-notification" style="width: 95%;"></div>
        </div>
        <div id="noNotifications">No new notifications.</div>
    </div>

    <script>
        // --- Supabase and Global Utility Initialization ---
        const SUPABASE_URL = "https://vfbjwkfurleatfdrabdg.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZmYmp3a2Z1cmxlYXRmZHJhYmRnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc0MjAwNDIsImV4cCI6MjA3Mjk5NjA0Mn0.hguIfyynGc19tsSm9u66qy5IeUv40_mE8-JBjqnOQBE";
        // Corrected variable name to supabaseClient to prevent "already declared" error
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        // --- Element Declarations ---
        const notificationList = document.getElementById('notificationList');
        const noNotificationsEl = document.getElementById('noNotifications');
        
        let currentUser = null;

        // --- Utility Functions ---

        // Helper to format time
        function timeAgo(dateString) {
            const now = new Date();
            const past = new Date(dateString);
            const seconds = Math.floor((now - past) / 1000);

            let interval = seconds / 31536000;
            if (interval > 1) return Math.floor(interval) + " years ago";
            interval = seconds / 2592000;
            if (interval > 1) return Math.floor(interval) + " months ago";
            interval = seconds / 86400;
            if (interval > 1) return Math.floor(interval) + " days ago";
            interval = seconds / 3600;
            if (interval > 1) return Math.floor(interval) + " hours ago";
            interval = seconds / 60;
            if (interval > 1) return Math.floor(interval) + " minutes ago";
            return Math.floor(seconds) + " seconds ago";
        }

        // --- Main Logic: Fetching and Displaying ---

        async function fetchAndDisplayNotifications() {
            // Remove placeholders
            document.querySelectorAll('.placeholder-notification').forEach(el => el.remove());

            // Fetch notifications, including related_id
            const { data: notifications, error } = await supabaseClient
                .from('notifications')
                .select(`id, type, message, read_status, created_at, sender_id, related_id`)
                .eq('recipient_id', currentUser.id)
                .order('created_at', { ascending: false });

            if (error) {
                console.error('Error fetching notifications:', error.message);
                notificationList.innerHTML = `<p style="color: #ef4444; text-align: center;">Error loading notifications.</p>`;
                return;
            }

            notificationList.innerHTML = '';
            if (notifications.length === 0) {
                noNotificationsEl.style.display = 'block';
                return;
            }

            // Batch fetch sender profiles
            const senderIds = [...new Set(notifications.map(n => n.sender_id).filter(id => id))]; // Filter out null sender_id
            const { data: profiles, error: profileError } = await supabaseClient
                .from('profiles')
                .select('user_id, full_name, avatar_url')
                .in('user_id', senderIds);
            
            if (profileError) {
                console.error("Error fetching profiles:", profileError.message);
                // Proceed without profiles if there's an error
            }

            const profileMap = new Map((profiles || []).map(p => [p.user_id, p]));

            noNotificationsEl.style.display = 'none';

            notifications.forEach(notification => {
                const notificationItem = document.createElement('div');
                notificationItem.className = `notification-item ${notification.read_status ? '' : 'unread'}`;
                
                // Set a data attribute to store the entire notification object for easy access
                notificationItem.dataset.notification = JSON.stringify(notification);

                const senderProfile = profileMap.get(notification.sender_id);
                const avatar = senderProfile?.avatar_url;
                const senderName = senderProfile?.full_name || 'A user';

                let avatarHtml = `<div class="notification-avatar-placeholder" title="${senderName}"><i class="fa-solid fa-user"></i></div>`;
                if (avatar) {
                    avatarHtml = `<img src="${avatar}" alt="User Avatar" class="notification-avatar">`;
                }

                let notificationMessage = '';
                // Determine message based on type
                switch (notification.type) {
                    case 'post_liked':
                        notificationMessage = `<strong>${senderName}</strong> liked your post.`;
                        break;
                    case 'post_commented':
                        notificationMessage = `<strong>${senderName}</strong> commented: "${notification.message}"`;
                        break;
                    case 'friend_post':
                        notificationMessage = `<strong>${senderName}</strong> posted something new.`;
                        break;
                    case 'friend_request':
                        notificationMessage = `<strong>${senderName}</strong> sent you a friend request.`;
                        break;
                    default:
                        notificationMessage = notification.message || 'New activity on your account.';
                }

                let actionsHtml = '';
                if (notification.type === 'friend_request') {
                    actionsHtml = `
                        <div class="notification-actions" data-notification-id="${notification.id}">
                            <button class="accept-btn" data-sender-id="${notification.sender_id}">Accept</button>
                            <button class="reject-btn" data-sender-id="${notification.sender_id}">Reject</button>
                        </div>
                    `;
                }

                notificationItem.innerHTML = `
                    ${avatarHtml}
                    <div class="notification-content">
                        <p>${notificationMessage}</p>
                        <small>${timeAgo(notification.created_at)}</small>
                    </div>
                    ${actionsHtml}
                `;
                
                notificationList.appendChild(notificationItem);
            });

            // Add event listeners for all notification items
            document.querySelectorAll('.notification-item').forEach(item => {
                const notification = JSON.parse(item.dataset.notification);
                
                // Only non-friend-request notifications should redirect
                if (notification.type !== 'friend_request') {
                    item.addEventListener('click', () => {
                        handleNotificationClick(item, notification);
                    });
                }
            });

            // Add event listeners for new buttons
            document.querySelectorAll('.accept-btn').forEach(button => {
                button.addEventListener('click', async (event) => {
                    event.stopPropagation();
                    const senderId = event.target.dataset.senderId;
                    const notificationItem = event.target.closest('.notification-item');
                    const notificationId = JSON.parse(notificationItem.dataset.notification).id;
                    await handleFriendRequest(senderId, notificationId, 'accepted', notificationItem);
                });
            });

            document.querySelectorAll('.reject-btn').forEach(button => {
                button.addEventListener('click', async (event) => {
                    event.stopPropagation();
                    const senderId = event.target.dataset.senderId;
                    const notificationItem = event.target.closest('.notification-item');
                    const notificationId = JSON.parse(notificationItem.dataset.notification).id;
                    await handleFriendRequest(senderId, notificationId, 'rejected', notificationItem);
                });
            });
        }

        // --- Action Handlers ---

        async function handleFriendRequest(senderId, notificationId, status, notificationElement) {
            // Find the friend request in the friend_requests table
            const { data: request, error: fetchError } = await supabaseClient
                .from('friend_requests')
                .select('id')
                .eq('sender_id', senderId)
                .eq('receiver_id', currentUser.id)
                .single();

            if (fetchError && fetchError.code !== 'PGRST116') { // PGRST116 means 'No rows found'
                console.error('Error fetching friend request:', fetchError.message);
                return;
            }
            
            if (!request) {
                console.warn('Friend request not found, possibly already processed.');
            }

            if (status === 'accepted') {
                if (request) {
                    const { error: updateError } = await supabaseClient
                        .from('friend_requests')
                        .update({ status: 'accepted' })
                        .eq('id', request.id);

                    if (updateError) {
                        console.error('Error accepting request:', updateError.message);
                        return;
                    }
                }
            } else if (status === 'rejected') {
                if (request) {
                    const { error: deleteError } = await supabaseClient
                        .from('friend_requests')
                        .delete()
                        .eq('id', request.id);

                    if (deleteError) {
                        console.error('Error rejecting request:', deleteError.message);
                        return;
                    }
                }
            }

            // Delete the notification record from the database
            const { error: notificationError } = await supabaseClient
                .from('notifications')
                .delete()
                .eq('id', notificationId);

            if (notificationError) {
                console.error('Error deleting notification:', notificationError.message);
            }
            
            // Remove the UI element
            if (notificationElement) {
                notificationElement.remove();
            }

            if (notificationList.children.length === 0) {
                noNotificationsEl.style.display = 'block';
            }
        }

        async function handleNotificationClick(itemElement, notification) {
            // Check if the notification has a related_id (like/comment/post)
            if (notification.related_id) {
                // Mark the notification as read in the DB
                await markNotificationAsRead(notification.id);
                
                // Update UI instantly
                itemElement.classList.remove('unread');
                
                // Redirect the user to the feed page, with the post ID in the URL for scrolling
                window.location.href = `feed.html?post_id=${notification.related_id}`;
            }
        }

        async function markNotificationAsRead(notificationId) {
            const { error } = await supabaseClient
                .from('notifications')
                .update({ read_status: true })
                .eq('id', notificationId);

            if (error) {
                console.error("Error marking notification as read:", error.message);
            }
        }

        // --- Initialization ---

        document.addEventListener('DOMContentLoaded', async () => {
            // FIX: Use getSession() to reliably retrieve the session state immediately on page load.
            const { data: { session } } = await supabaseClient.auth.getSession();
            
            if (session) {
                // If the session exists, set the user and proceed.
                currentUser = session.user;
                
                // Mark ALL unread notifications as read on page load via a single query
                await supabaseClient
                    .from('notifications')
                    .update({ read_status: true })
                    .eq('recipient_id', currentUser.id)
                    .eq('read_status', false);

                fetchAndDisplayNotifications();
            } else {
                // If no valid session, redirect.
                window.location.href = 'index.html';
                return;
            }
        });
    </script>
</body>
</html>
