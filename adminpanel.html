<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Market Admin | Campus Cupid</title>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root { --primary: #fbbf24; --bg: #0f172a; --card: rgba(255,255,255,0.05); --text: #fff; }
    body { font-family: sans-serif; background: var(--bg); color: var(--text); padding: 20px; margin: 0; }
    .container { max-width: 900px; margin: auto; padding: 20px; }
    .card { background: var(--card); padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.1); }
    input, select { width: 100%; padding: 12px; margin: 10px 0; border-radius: 8px; background: #1e293b; color: white; border: 1px solid #334155; box-sizing: border-box; }
    button { background: var(--primary); padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.2s; }
    button:hover { opacity: 0.8; }
    .order-row { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #333; cursor: pointer; position: relative; }
    .order-row:hover { background: rgba(255,255,255,0.02); }
    .msg-badge { background: #ef4444; color: white; border-radius: 50%; padding: 2px 8px; font-size: 0.7rem; margin-left: 10px; }
    .inventory-item { display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px; margin-bottom: 8px; }
    .del-btn { background: #ef4444; color: white; padding: 5px 12px; font-size: 0.8rem; }
    
    /* Chat Modal */
    .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:1000; }
    .modal-content { max-width: 500px; margin: 50px auto; background: #1e293b; border-radius: 15px; display: flex; flex-direction: column; height: 80vh; }
    #chat-box { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; }
    .msg { padding: 10px; border-radius: 10px; max-width: 80%; }
    .msg.admin { background: var(--primary); color: #000; align-self: flex-end; }
    .msg.user { background: rgba(255,255,255,0.1); align-self: flex-start; }
  </style>
</head>
<body>

<div class="container">
  <h1>Admin Command Center</h1>
  
  <div class="card">
    <h3><i class="fa-solid fa-plus"></i> Add New Product</h3>
    <input type="file" id="prod-img" accept="image/*">
    <input type="text" id="prod-name" placeholder="Product Name">
    <input type="number" id="prod-price" placeholder="Price">
    <button onclick="uploadProduct()">Optimize & Post Product</button>
  </div>

  <div class="card">
    <h3><i class="fa-solid fa-boxes-stacked"></i> Current Inventory</h3>
    <div id="inventory-list">Loading products...</div>
  </div>

  <div class="card">
    <h3><i class="fa-solid fa-receipt"></i> Active Orders</h3>
    <div id="admin-orders">Loading orders...</div>
  </div>
</div>

<div id="admin-chat-modal" class="modal">
  <div class="modal-content">
    <div style="padding:15px; border-bottom:1px solid #334155; display:flex; justify-content:space-between; align-items:center">
      <b id="modal-title">Chat</b>
      <button onclick="closeChat()" style="background:none; color:white; font-size:1.5rem">&times;</button>
    </div>
    <div id="chat-box"></div>
    <div style="padding:15px; display:flex; gap:10px; border-top:1px solid #334155">
      <input type="text" id="admin-reply-in" placeholder="Type a reply...">
      <button onclick="sendReply()" style="width:auto">Send</button>
    </div>
  </div>
</div>

<script>
  const supabaseClient = window.supabase.createClient("https://vfbjwkfurleatfdrabdg.supabase.co", "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZmYmp3a2Z1cmxlYXRmZHJhYmRnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc0MjAwNDIsImV4cCI6MjA3Mjk5NjA0Mn0.hguIfyynGc19tsSm9u66qy5IeUv40_mE8-JBjqnOQBE");
  
  let activeOrderId = null;
  let localMsgHistory = {};

  async function startAdmin() {
    loadInventory();
    loadOrders();
    // Silent polling every 3 seconds
    setInterval(loadOrders, 3000);
    setInterval(pollActiveChat, 3000);
  }

  // --- Product Logic ---
  async function uploadProduct() {
    const file = document.getElementById('prod-img').files[0];
    const name = document.getElementById('prod-name').value;
    const price = document.getElementById('prod-price').value;
    if(!file || !name || !price) return alert("Fill all fields");

    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = e => {
      const img = new Image();
      img.src = e.target.result;
      img.onload = () => {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = 600; canvas.height = 600; // Force resize for speed
        ctx.drawImage(img, 0, 0, 600, 600);
        canvas.toBlob(async blob => {
          const fileName = `prod_${Date.now()}.jpg`;
          await supabaseClient.storage.from('product-images').upload(fileName, blob);
          const { data: { publicUrl } } = supabaseClient.storage.from('product-images').getPublicUrl(fileName);
          await supabaseClient.from('products').insert([{ name, price, image_url: publicUrl }]);
          alert("Product Added!");
          location.reload();
        }, 'image/jpeg', 0.6); // 40% compression
      }
    }
  }

  async function loadInventory() {
    const { data } = await supabaseClient.from('products').select('*').order('created_at', {ascending: false});
    document.getElementById('inventory-list').innerHTML = data.map(p => `
      <div class="inventory-item">
        <span><b>${p.name}</b> - $${p.price}</span>
        <button class="del-btn" onclick="deleteProduct('${p.id}')">Delete</button>
      </div>
    `).join('');
  }

  async function deleteProduct(id) {
    if(confirm("Are you sure you want to delete this product?")) {
      await supabaseClient.from('products').delete().eq('id', id);
      loadInventory();
    }
  }

  // --- Order Logic ---
  async function loadOrders() {
    const { data: orders } = await supabaseClient.from('orders').select('*').order('created_at', {ascending: false});
    const { data: chats } = await supabaseClient.from('market_chats').select('order_id');
    
    // Count messages for badges
    const dbCounts = {};
    chats.forEach(c => dbCounts[c.order_id] = (dbCounts[c.order_id] || 0) + 1);

    document.getElementById('admin-orders').innerHTML = orders.map(o => {
      const savedCount = localStorage.getItem('admin_seen_' + o.id) || 0;
      const unread = dbCounts[o.id] - savedCount;

      return `
        <div class="order-row" onclick="openChat('${o.id}')">
          <div>
            <b>Order #${o.id.slice(0,5)}</b> - $${o.total_price}
            ${unread > 0 ? `<span class="msg-badge">${unread} New</span>` : ''}
          </div>
          <select onclick="event.stopPropagation()" onchange="updateStatus('${o.id}', this.value)">
            <option value="Awaiting" ${o.status=='Awaiting'?'selected':''}>Awaiting Payment</option>
            <option value="Packaging" ${o.status=='Packaging'?'selected':''}>Packaging</option>
            <option value="Shipping" ${o.status=='Shipping'?'selected':''}>Shipping</option>
            <option value="Delivered" ${o.status=='Delivered'?'selected':''}>Delivered</option>
          </select>
        </div>
      `;
    }).join('');
  }

  async function updateStatus(id, newStatus) {
    // 1. Update the order status
    await supabaseClient.from('orders').update({ status: newStatus }).eq('id', id);
    
    // 2. Automatically send a chat message notifying the client
    const statusMsg = `ðŸ“¢ Status Update: Your Order #${id.slice(0,5)} is now [${newStatus}].`;
    await supabaseClient.from('market_chats').insert([{
      order_id: id,
      text: statusMsg,
      is_admin_reply: true
    }]);

    alert("Status updated and client notified!");
    loadOrders();
  }

  // --- Chat Logic ---
  async function openChat(id) {
    activeOrderId = id;
    document.getElementById('modal-title').innerText = `Chatting: Order #${id.slice(0,5)}`;
    document.getElementById('admin-chat-modal').style.display = 'block';
    refreshChatBox();
  }

  async function pollActiveChat() {
    if(activeOrderId) refreshChatBox();
  }

  async function refreshChatBox() {
    const { data: msgs } = await supabaseClient.from('market_chats').select('*').eq('order_id', activeOrderId).order('created_at', {ascending: true});
    
    document.getElementById('chat-box').innerHTML = msgs.map(m => `
      <div class="msg ${m.is_admin_reply ? 'admin' : 'user'}">${m.text}</div>
    `).join('');
    
    const box = document.getElementById('chat-box');
    box.scrollTop = box.scrollHeight;

    // Save that we have seen these messages
    localStorage.setItem('admin_seen_' + activeOrderId, msgs.length);
  }

  async function sendReply() {
    const text = document.getElementById('admin-reply-in').value;
    if(!text || !activeOrderId) return;
    
    await supabaseClient.from('market_chats').insert([{
      order_id: activeOrderId,
      text: text,
      is_admin_reply: true
    }]);

    document.getElementById('admin-reply-in').value = "";
    refreshChatBox();
  }

  function closeChat() { 
    document.getElementById('admin-chat-modal').style.display = 'none'; 
    activeOrderId = null; 
    loadOrders(); 
  }

  startAdmin();
</script>
</body>
</html>
