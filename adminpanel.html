<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard | Campus Cupid</title>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #fbbf24;
      --primary-hover: #f59e0b;
      --bg: #0f172a;
      --card-bg: #1e293b;
      --border: #334155;
      --text-main: #f8fafc;
      --text-dim: #94a3b8;
      --success: #22c55e;
      --danger: #ef4444;
      --accent: #6366f1;
    }

    * { box-sizing: border-box; transition: all 0.2s ease; }
    
    body { 
      font-family: 'Inter', sans-serif; 
      background: var(--bg); 
      color: var(--text-main); 
      margin: 0; 
      padding: 0;
      line-height: 1.5;
    }

    /* Layout */
    .admin-header {
      background: var(--card-bg);
      padding: 1rem 1.5rem;
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      z-index: 100;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }

    .admin-header h1 { margin: 0; font-size: 1.1rem; font-weight: 700; color: var(--primary); text-transform: uppercase; letter-spacing: 1px; }

    .container { 
      max-width: 1100px; 
      margin: 20px auto; 
      padding: 0 15px; 
      display: grid; 
      grid-template-columns: 1fr; 
      gap: 20px; 
    }

    @media (min-width: 768px) {
      .grid-layout { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
      .full-width { grid-column: 1 / -1; }
    }

    /* Cards */
    .card { 
      background: var(--card-bg); 
      padding: 1.5rem; 
      border-radius: 16px; 
      border: 1px solid var(--border);
    }

    h3 { margin-top: 0; font-size: 1rem; display: flex; align-items: center; gap: 10px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.5px; }

    label { display: block; margin-bottom: 5px; font-size: 0.8rem; color: var(--text-dim); font-weight: 500; }

    input, select { 
      width: 100%; 
      padding: 12px 16px; 
      margin-bottom: 16px; 
      border-radius: 10px; 
      background: #0f172a; 
      color: white; 
      border: 1px solid var(--border); 
      font-size: 0.95rem;
      outline: none;
    }

    input:focus { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(251, 191, 36, 0.2); }

    button { 
      background: var(--primary); 
      color: #000;
      padding: 12px 20px; 
      border: none; 
      border-radius: 10px; 
      font-weight: 700; 
      cursor: pointer; 
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    button:hover { background: var(--primary-hover); transform: translateY(-1px); }

    /* Inventory Items */
    .inventory-item { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      background: rgba(15, 23, 42, 0.5); 
      padding: 12px 16px; 
      border-radius: 12px; 
      margin-bottom: 10px; 
      border: 1px solid var(--border);
    }

    .del-btn { background: rgba(239, 68, 68, 0.1); color: var(--danger); width: auto; padding: 8px 12px; }
    .del-btn:hover { background: var(--danger); color: white; }

    /* Order Rows */
    .order-row { 
      background: rgba(255,255,255,0.02);
      border: 1px solid var(--border);
      border-radius: 12px;
      margin-bottom: 12px;
      padding: 15px;
      cursor: pointer;
    }
    .order-row:hover { border-color: var(--primary); background: rgba(251, 191, 36, 0.05); }

    .order-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
    
    .msg-badge { 
      background: var(--danger); 
      color: white; 
      border-radius: 6px; 
      padding: 2px 8px; 
      font-size: 0.7rem; 
      font-weight: bold;
      margin-left: 8px;
    }

    /* Modal */
    .modal { 
      display:none; 
      position:fixed; 
      top:0; left:0; 
      width:100%; height:100%; 
      background:rgba(15, 23, 42, 0.9); 
      z-index:1000; 
      backdrop-filter: blur(4px);
    }
    
    .modal-content { 
      max-width: 500px; 
      margin: 20px auto; 
      background: var(--card-bg); 
      border-radius: 20px; 
      display: flex; 
      flex-direction: column; 
      height: 90vh; 
      border: 1px solid var(--border);
    }

    #chat-box { 
      flex: 1; 
      overflow-y: auto; 
      padding: 20px; 
      display: flex; 
      flex-direction: column; 
      gap: 12px;
      background: #0f172a;
    }

    .msg { padding: 10px 15px; border-radius: 14px; max-width: 80%; font-size: 0.9rem; }
    .msg.admin { background: var(--primary); color: #000; align-self: flex-end; border-bottom-right-radius: 2px; }
    .msg.user { background: var(--border); color: white; align-self: flex-start; border-bottom-left-radius: 2px; }

    .chat-footer { padding: 15px; display: flex; gap: 10px; background: var(--card-bg); border-top: 1px solid var(--border); }
    .chat-footer input { margin-bottom: 0; }
    .chat-footer button { width: auto; }

  </style>
</head>
<body>

<header class="admin-header">
  <h1><i class="fa-solid fa-bolt"></i> Campus Cupid Admin</h1>
  <div style="color: var(--success); font-size: 0.8rem; font-weight: 600;">
    <i class="fa-solid fa-circle-check"></i> ACTIVE SESSION
  </div>
</header>

<div class="container">
  
  <div class="grid-layout">
    <div class="card">
      <h3><i class="fa-solid fa-cart-plus"></i> Add Product</h3>
      <label>Product Image</label>
      <input type="file" id="prod-img" accept="image/*">
      <label>Product Name</label>
      <input type="text" id="prod-name" placeholder="e.g. Heart-shaped Gift Box">
      <label>Price (KES)</label>
      <input type="number" id="prod-price" placeholder="Amount in Shillings">
      <button onclick="uploadProduct()"><i class="fa-solid fa-check-circle"></i> Save & Publish</button>
    </div>

    <div class="card">
      <h3><i class="fa-solid fa-warehouse"></i> Inventory</h3>
      <div id="inventory-list" style="max-height: 320px; overflow-y: auto;">
        <p style="text-align:center; color:var(--text-dim); padding:20px;">Fetching products...</p>
      </div>
    </div>
  </div>

  <div class="card full-width">
    <h3><i class="fa-solid fa-list-check"></i> Order Management</h3>
    <div id="admin-orders">
      <p style="text-align:center; color:var(--text-dim); padding:20px;">Scanning for active orders...</p>
    </div>
  </div>
</div>

<div id="admin-chat-modal" class="modal">
  <div class="modal-content">
    <div style="padding:15px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center">
      <b id="modal-title" style="color: var(--primary)">Customer Correspondence</b>
      <button onclick="closeChat()" style="background:none; color:white; font-size:1.5rem; width:auto; padding:0; border:none; cursor:pointer">&times;</button>
    </div>
    <div id="chat-box"></div>
    <div class="chat-footer">
      <input type="text" id="admin-reply-in" placeholder="Write a message...">
      <button onclick="sendReply()"><i class="fa-solid fa-paper-plane"></i></button>
    </div>
  </div>
</div>

<script>
  // SUPABASE CLIENT
  const supabaseClient = window.supabase.createClient("https://vfbjwkfurleatfdrabdg.supabase.co", "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZmYmp3a2Z1cmxlYXRmZHJhYmRnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc0MjAwNDIsImV4cCI6MjA3Mjk5NjA0Mn0.hguIfyynGc19tsSm9u66qy5IeUv40_mE8-JBjqnOQBE");
  
  let activeOrderId = null;

  async function startAdmin() {
    loadInventory();
    loadOrders();
    setInterval(loadOrders, 3000); 
    setInterval(pollActiveChat, 3000); 
  }

  // --- Product Management ---
  async function uploadProduct() {
    const file = document.getElementById('prod-img').files[0];
    const name = document.getElementById('prod-name').value;
    const price = document.getElementById('prod-price').value;
    if(!file || !name || !price) return alert("Fill all fields first.");

    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = e => {
      const img = new Image();
      img.src = e.target.result;
      img.onload = () => {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = 600; canvas.height = 600;
        ctx.drawImage(img, 0, 0, 600, 600);
        canvas.toBlob(async blob => {
          const fileName = `prod_${Date.now()}.jpg`;
          await supabaseClient.storage.from('product-images').upload(fileName, blob);
          const { data: { publicUrl } } = supabaseClient.storage.from('product-images').getPublicUrl(fileName);
          await supabaseClient.from('products').insert([{ name, price, image_url: publicUrl }]);
          alert("Product successfully added!");
          location.reload();
        }, 'image/jpeg', 0.6);
      }
    }
  }

  async function loadInventory() {
    const { data } = await supabaseClient.from('products').select('*').order('created_at', {ascending: false});
    if(!data) return;
    document.getElementById('inventory-list').innerHTML = data.map(p => `
      <div class="inventory-item">
        <div>
            <div style="font-weight:600; color:white;">${p.name}</div>
            <div style="font-size:0.85rem; color:var(--primary);">KES ${p.price}</div>
        </div>
        <button class="del-btn" onclick="deleteProduct('${p.id}')"><i class="fa-solid fa-trash-can"></i></button>
      </div>
    `).join('');
  }

  async function deleteProduct(id) {
    if(confirm("Remove this item from the market?")) {
      await supabaseClient.from('products').delete().eq('id', id);
      loadInventory();
    }
  }

  // --- Order Management ---
  async function loadOrders() {
    const { data: orders } = await supabaseClient.from('orders').select('*').order('created_at', {ascending: false});
    const { data: chats } = await supabaseClient.from('market_chats').select('order_id');
    
    if(!orders) return;

    const dbCounts = {};
    chats.forEach(c => dbCounts[c.order_id] = (dbCounts[c.order_id] || 0) + 1);

    document.getElementById('admin-orders').innerHTML = orders.map(o => {
      const savedCount = localStorage.getItem('admin_seen_' + o.id) || 0;
      const unread = dbCounts[o.id] - savedCount;

      return `
        <div class="order-row" onclick="openChat('${o.id}')">
          <div class="order-header">
            <div>
              <span style="color:var(--text-dim); font-size:0.75rem;">Order #${o.id.slice(0,5).toUpperCase()}</span>
              <div style="font-weight:700; font-size:1.1rem; color:white;">KES ${o.total_price}</div>
              ${unread > 0 ? `<span class="msg-badge">${unread} NEW</span>` : ''}
            </div>
            <div style="text-align:right">
               <select onclick="event.stopPropagation()" onchange="updateStatus('${o.id}', this.value)" style="margin-bottom:0; padding:6px; width:auto; font-size:0.8rem; border-radius:6px;">
                <option value="Awaiting" ${o.status=='Awaiting'?'selected':''}>Awaiting Payment</option>
                <option value="Packaging" ${o.status=='Packaging'?'selected':''}>Packaging</option>
                <option value="Shipping" ${o.status=='Shipping'?'selected':''}>Shipping</option>
                <option value="Delivered" ${o.status=='Delivered'?'selected':''}>Delivered</option>
              </select>
            </div>
          </div>
        </div>
      `;
    }).join('');
  }

  async function updateStatus(id, newStatus) {
    await supabaseClient.from('orders').update({ status: newStatus }).eq('id', id);
    const statusMsg = `ðŸ“¢ Update: Your Order #${id.slice(0,5).toUpperCase()} is now [${newStatus}].`;
    await supabaseClient.from('market_chats').insert([{
      order_id: id,
      text: statusMsg,
      is_admin_reply: true
    }]);
    loadOrders();
  }

  // --- Chat Management ---
  async function openChat(id) {
    activeOrderId = id;
    document.getElementById('modal-title').innerText = `Chat: #${id.slice(0,5).toUpperCase()}`;
    document.getElementById('admin-chat-modal').style.display = 'block';
    refreshChatBox();
  }

  async function pollActiveChat() {
    if(activeOrderId) refreshChatBox();
  }

  async function refreshChatBox() {
    const { data: msgs } = await supabaseClient.from('market_chats').select('*').eq('order_id', activeOrderId).order('created_at', {ascending: true});
    if(!msgs) return;
    
    document.getElementById('chat-box').innerHTML = msgs.map(m => `
      <div class="msg ${m.is_admin_reply ? 'admin' : 'user'}">${m.text}</div>
    `).join('');
    
    const box = document.getElementById('chat-box');
    box.scrollTop = box.scrollHeight;
    localStorage.setItem('admin_seen_' + activeOrderId, msgs.length);
  }

  async function sendReply() {
    const text = document.getElementById('admin-reply-in').value;
    if(!text || !activeOrderId) return;
    
    await supabaseClient.from('market_chats').insert([{
      order_id: activeOrderId,
      text: text,
      is_admin_reply: true
    }]);

    document.getElementById('admin-reply-in').value = "";
    refreshChatBox();
  }

  function closeChat() { 
    document.getElementById('admin-chat-modal').style.display = 'none'; 
    activeOrderId = null; 
    loadOrders(); 
  }

  startAdmin();
</script>
</body>
</html>
 
