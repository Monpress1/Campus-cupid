<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Campus Cupid ❤️ - Chat</title>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
body{
  margin:0;font-family:"Segoe UI",Arial,sans-serif;
  background:linear-gradient(135deg,#0f172a,#1e293b,#334155);
  color:#fff;min-height:100vh;
  display:flex;justify-content:center;align-items:flex-start;
}
.chat-container{
  display:flex;width:100%;max-width:900px;height:95vh;
  border-radius:1rem;background:rgba(30,41,59,0.55);
  backdrop-filter:blur(10px);overflow:hidden;
  box-shadow:0 4px 20px rgba(0,0,0,0.45);
}

/* ---- Friends Sidebar ---- */
.friends-sidebar{
  width:35%;max-width:300px;background:#111827;
  border-right:1px solid #334155;
  display:flex;flex-direction:column;padding:1.5rem 0;
}
.friends-sidebar h2{
  margin:0 1.5rem 1rem;
  padding-bottom:0.5rem;
  border-bottom:2px solid #1f2937;
  font-size:1.2rem;
  letter-spacing:.5px;
}
.friends-list{flex:1;overflow-y:auto;padding:0 .75rem;}
.friend-item{
  position:relative;
  display:flex;align-items:center;gap:1rem;
  padding:.8rem 1rem;margin:.5rem 0;
  background:rgba(255,255,255,0.04);
  border-radius:.75rem;
  cursor:pointer;
  transition:background .25s,transform .25s;
}
.friend-item:hover,
.friend-item.active{
  background:rgba(255,255,255,0.1);
  transform:translateY(-2px);
}
.friend-item img,.friend-item .user-icon{
  width:54px;height:54px;border-radius:50%;
  object-fit:cover;
  border:2px solid #fbbf24;
  box-shadow:0 0 8px rgba(251,191,36,.5);
}
.friend-info h4{margin:0;font-size:1rem;font-weight:600;}
.friend-info p{margin:2px 0 0;font-size:0.8rem;color:#9ca3af;}
.unread-badge{
  position:absolute;top:6px;right:8px;
  background:#ef4444;color:#fff;
  border-radius:50%;width:20px;height:20px;
  font-size:.7rem;display:none;
  align-items:center;justify-content:center;
}

/* ---- Chat Pane ---- */
.chat-pane{flex:1;display:flex;flex-direction:column;position:relative;}
.chat-pane.hidden{display:none;}
.chat-header{
  display:flex;align-items:center;gap:1rem;
  padding:1rem;border-bottom:1px solid #334155;
}
.chat-header img,.chat-header .user-icon{
  width:50px;height:50px;border-radius:50%;
  object-fit:cover;border:2px solid #fbbf24;
}
.chat-header h3{margin:0;}
.chat-messages{
  flex:1;overflow-y:auto;padding:1rem;
  display:flex;flex-direction:column;gap:.75rem;
  /* Removed scroll-behavior: smooth; */
}
.message{
  padding:.75rem 1rem;border-radius:1.2rem;
  max-width:80%;word-wrap:break-word;font-size:.95rem;
}
.message.sent{
  background:#fbbf24;color:#1e293b;
  align-self:flex-end;border-bottom-right-radius:.3rem;
}
.message.received{
  background:#334155;color:#fff;
  align-self:flex-start;border-bottom-left-radius:.3rem;
}
.message-input-container{
  display:flex;gap:.75rem;padding:1rem;
  border-top:1px solid #334155;
}
#messageInput{
  flex:1;padding:.75rem;border-radius:1.5rem;
  border:1px solid #475569;background:#0f172a;
  color:#fff;font-size:1rem;
}
#sendMessageBtn{
  background:#fbbf24;color:#1e293b;border:none;
  padding:0 1.25rem;border-radius:1.5rem;
  font-weight:bold;font-size:1rem;cursor:pointer;
  transition:background .2s;
}
#sendMessageBtn:hover{background:#f59e0b;}
.chat-placeholder{
  flex:1;display:flex;flex-direction:column;
  justify-content:center;align-items:center;
  color:#94a3b8;text-align:center;
}
.chat-placeholder i{font-size:4rem;margin-bottom:1rem;}
.back-arrow {
  display: none;
}

@media (max-width:768px){
  .chat-container{flex-direction:column;height:100vh;}
  .friends-sidebar{width:100%;border-right:none;border-bottom:1px solid #334155;height:40vh;display:flex!important;}
  .chat-pane{width:100%;height:60vh;display:flex!important;}
  .chat-pane.hidden{display:none!important;}
  .friends-sidebar.hidden{display:none!important;}
  .back-arrow {
    display: block;
  }
}
</style>
</head>
<body>

<div class="chat-container">
  <div class="friends-sidebar" id="friendsSidebar">
    <h2>Friends</h2>
    <div class="friends-list" id="friendsList">
      <p style="text-align:center;color:#94a3b8;">Loading friends...</p>
    </div>
  </div>

  <div class="chat-pane hidden" id="chatPane">
    <div class="chat-header" id="chatHeader">
      <i class="fa-solid fa-arrow-left back-arrow" style="cursor:pointer; margin-right: 1rem;"></i>
      <div class="user-icon"><i class="fa-solid fa-user"></i></div>
      <h3>Select a friend to start chatting</h3>
    </div>
    <div class="chat-messages" id="chatMessages">
      <div class="chat-placeholder">
        <i class="fa-solid fa-comments"></i>
        <h3>Let's start a conversation!</h3>
      </div>
    </div>
    <div class="message-input-container">
      <input type="text" id="messageInput" placeholder="Type a message..." disabled/>
      <button id="sendMessageBtn" disabled><i class="fa-solid fa-paper-plane"></i></button>
    </div>
  </div>
</div>

<script>
const SUPABASE_URL="https://vfbjwkfurleatfdrabdg.supabase.co";
const SUPABASE_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZmYmp3a2Z1cmxlYXRmZHJhYmRnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc0MjAwNDIsImV4cCI6MjA3Mjk5NjA0Mn0.hguIfyynGc19tsSm9u66qy5IeUv40_mE8-JBjqnOQBE";
const supabase=window.supabase.createClient(SUPABASE_URL,SUPABASE_KEY);

const friendsList=document.getElementById("friendsList");
const chatMessages=document.getElementById("chatMessages");
const messageInput=document.getElementById("messageInput");
const sendBtn=document.getElementById("sendMessageBtn");
const chatHeader=document.getElementById("chatHeader");
const friendsSidebar=document.getElementById("friendsSidebar");
const chatPane=document.getElementById("chatPane");
const backArrow=document.querySelector('.back-arrow');

let currentUserId,currentFriendId,profilesMap=new Map();
let lastMessageTimestamp = null;
let pollingInterval = null;

init();

async function init(){
  const {data:{user}}=await supabase.auth.getUser();
  if(!user){location.href="index.html";return;}
  currentUserId=user.id;
  loadFriends();
  // We'll rely on polling now instead of a continuous realtime subscription
  // listenRealtime(); 
}

async function loadFriends(){
  const {data:friendships}=await supabase
     .from('friend_requests')
     .select('sender_id,receiver_id,status')
     .or(`sender_id.eq.${currentUserId},receiver_id.eq.${currentUserId}`)
     .eq('status','accepted');

  const ids=[...new Set(friendships.map(f=>
      f.sender_id===currentUserId?f.receiver_id:f.sender_id
  ))];

  if(!ids.length){
    friendsList.innerHTML="<p style='text-align:center;color:#94a3b8;'>No friends yet.</p>";
    return;
  }

  const {data:profiles}=await supabase.from('profiles').select('*').in('user_id',ids);
  friendsList.innerHTML="";
  profiles.sort((a,b) => a.full_name.localeCompare(b.full_name));

  for (const p of profiles) {
    profilesMap.set(p.user_id,p);

    const { data: messages } = await supabase.from('messages')
      .select('content')
      .or(`and(sender_id.eq.${currentUserId},receiver_id.eq.${p.user_id}),and(sender_id.eq.${p.user_id},receiver_id.eq.${currentUserId})`)
      .order('created_at', { ascending: false })
      .limit(1);

    const lastMessage = messages?.[0]?.content || "No messages yet.";

    const { count: unreadCount } = await supabase.from('messages')
      .select('id', { count: 'exact' })
      .eq('sender_id', p.user_id)
      .eq('receiver_id', currentUserId)
      .eq('read_status', false);

    const el = document.createElement('div');
    el.className = 'friend-item';
    el.dataset.userId = p.user_id;
    el.innerHTML = `
      ${p.avatar_url?`<img src="${p.avatar_url}">`:`<div class="user-icon"><i class="fa-solid fa-user"></i></div>`}
      <div class="friend-info">
        <h4>${p.full_name}</h4>
        <p>${lastMessage}</p>
      </div>
      <span class="unread-badge" style="display:${unreadCount > 0 ? 'flex' : 'none'};">${unreadCount}</span>
    `;
    el.onclick=()=>openChat(p.user_id);
    friendsList.appendChild(el);
  }
}

async function openChat(friendId){
  if(currentFriendId===friendId)return;

  if (pollingInterval) {
    clearInterval(pollingInterval);
  }

  document.querySelectorAll('.friend-item').forEach(i=>i.classList.remove('active'));
  const friendItem=document.querySelector(`.friend-item[data-user-id="${friendId}"]`);
  if(friendItem){
     friendItem.classList.add('active');
     const unreadBadge = friendItem.querySelector('.unread-badge');
     unreadBadge.textContent = '0';
     unreadBadge.style.display = 'none';
  }
  currentFriendId=friendId;
  const p=profilesMap.get(friendId);
  chatHeader.innerHTML=`
    <i class="fa-solid fa-arrow-left back-arrow" style="cursor:pointer; margin-right: 1rem;"></i>
    ${p.avatar_url?`<img src="${p.avatar_url}">`:`<div class="user-icon"><i class="fa-solid fa-user"></i></div>`}
    <h3>${p.full_name}</h3>
  `;
  chatHeader.querySelector('.back-arrow').onclick=()=>{
      currentFriendId=null;
      chatPane.classList.add('hidden');
      friendsSidebar.classList.remove('hidden');
      document.querySelectorAll('.friend-item').forEach(i=>i.classList.remove('active'));
      clearInterval(pollingInterval);
  };
  messageInput.disabled=false; sendBtn.disabled=false;
  chatPane.classList.remove('hidden'); 
  friendsSidebar.classList.add('hidden');
  
  chatMessages.innerHTML = ""; // Clear existing messages
  lastMessageTimestamp = null; // Reset timestamp
  await loadMessages(friendId);
  await markRead(friendId);

  pollingInterval = setInterval(async () => {
    await pollForNewMessages(currentFriendId);
  }, 4000); // Polling every 4 seconds
}

async function loadMessages(friendId) {
    const { data: msgs, error } = await supabase.from('messages')
        .select('*')
        .or(`and(sender_id.eq.${currentUserId},receiver_id.eq.${friendId}),and(sender_id.eq.${friendId},receiver_id.eq.${currentUserId})`)
        .order('created_at', { ascending: true });

    if (error) {
        console.error('Error loading messages:', error);
        return;
    }

    if (!msgs || msgs.length === 0) {
        chatMessages.innerHTML = `<div class="chat-placeholder">
            <i class="fa-solid fa-comments"></i><h3>No messages yet</h3></div>`;
        lastMessageTimestamp = null;
        return;
    }

    chatMessages.innerHTML = "";
    msgs.forEach(displayMessage);
    scrollBottom();
    lastMessageTimestamp = msgs[msgs.length - 1].created_at;
}

async function pollForNewMessages(friendId) {
    const { data: newMsgs, error } = await supabase.from('messages')
        .select('*')
        .or(`and(sender_id.eq.${currentUserId},receiver_id.eq.${friendId}),and(sender_id.eq.${friendId},receiver_id.eq.${currentUserId})`)
        .gt('created_at', lastMessageTimestamp || '1970-01-01T00:00:00Z')
        .order('created_at', { ascending: true });

    if (error) {
        console.error('Error polling for new messages:', error);
        return;
    }

    if (newMsgs && newMsgs.length > 0) {
        // If the placeholder is present, remove it
        const placeholder = chatMessages.querySelector('.chat-placeholder');
        if (placeholder) {
            chatMessages.innerHTML = '';
        }

        newMsgs.forEach(displayMessage);
        scrollBottom();
        lastMessageTimestamp = newMsgs[newMsgs.length - 1].created_at;
        await markRead(friendId);
    }
}

function displayMessage(m){
  const div=document.createElement('div');
  div.className=`message ${m.sender_id===currentUserId?'sent':'received'}`;
  div.textContent=m.content;
  chatMessages.appendChild(div);
  scrollBottom();
}

function scrollBottom(){
  // No smooth scroll, just jump to the bottom
  chatMessages.scrollTop=chatMessages.scrollHeight;
}

sendBtn.onclick=sendMessage;
messageInput.addEventListener('keydown',e=>{if(e.key==="Enter")sendMessage();});

async function sendMessage(){
  const text=messageInput.value.trim();
  if(!text||!currentFriendId)return;
  sendBtn.disabled=true;
  
  const { data, error } = await supabase.from('messages').insert({
     sender_id:currentUserId,
     receiver_id:currentFriendId,
     content:text
  }).select();
  
  sendBtn.disabled=false;
  messageInput.value="";
  
  if (!error && data && data.length > 0) {
    displayMessage(data[0]);
    updateLastMessageInList(data[0]);
    lastMessageTimestamp = data[0].created_at; // Update timestamp for sent message
  }
}

function updateLastMessageInList(message) {
  const friendItem = document.querySelector(`.friend-item[data-user-id="${message.sender_id === currentUserId ? message.receiver_id : message.sender_id}"]`);
  if (friendItem) {
    friendItem.querySelector('.friend-info p').textContent = message.content;
  }
}

async function markRead(fid){
  await supabase.from('messages')
     .update({read_status:true})
     .eq('sender_id',fid)
     .eq('receiver_id',currentUserId)
     .eq('read_status',false);
}

// NOTE: This function is now commented out as we are using polling
/*
function listenRealtime() {
  const channel = supabase.channel('public:messages')
    .on(
      'postgres_changes',
      { 
        event: 'INSERT', 
        schema: 'public', 
        table: 'messages', 
        filter: `or(sender_id=eq.${currentUserId},receiver_id=eq.${currentUserId})` 
      },
      payload => {
        const m = payload.new;
        
        const friendItem = document.querySelector(`.friend-item[data-user-id="${m.sender_id === currentUserId ? m.receiver_id : m.sender_id}"]`);
        if (friendItem) {
          friendItem.querySelector('.friend-info p').textContent = m.content;
        }

        if (m.sender_id === currentFriendId || m.receiver_id === currentFriendId) {
          displayMessage(m);
          if (m.receiver_id === currentUserId) {
            markRead(currentFriendId);
          }
        } 
        
        if (m.receiver_id === currentUserId && m.sender_id !== currentFriendId) {
          const badge = document.querySelector(`.friend-item[data-user-id="${m.sender_id}"] .unread-badge`);
          if (badge) {
            badge.textContent = parseInt(badge.textContent || 0) + 1;
            badge.style.display = 'flex';
          }
        }
      }
    );

  channel.subscribe(status => {
    if (status === 'SUBSCRIBED') {
      console.log('Realtime connected to messages table');
    }
  });
}
*/
</script>
</body>
</html>
