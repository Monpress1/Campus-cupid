<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Campus Cupid ❤️ - Feed</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/compressorjs/dist/compressor.js"></script>
    <script src='https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.12.7/dist/ffmpeg.min.js'></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&family=Bebas+Neue&display=swap" rel="stylesheet">
    <link rel="manifest" href="manifest.json">

    <style>
        /* Base Styles & Utilities */
        body {
            margin: 0;
            font-family: "Segoe UI", Arial, sans-serif;
            background: linear-gradient(135deg, #0f172a, #1e293b, #334155);
            color: #fff;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 1rem;
            padding-top: 70px;
            transition: opacity 0.3s ease;
        }

        /* Loading Overlay */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 23, 42, 0.95);
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            gap: 1rem;
            z-index: 10000;
            color: #fff;
            font-size: 1.2rem;
            animation: fadeIn 0.5s ease-in-out;
        }
        #loading-overlay .spinner {
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-top: 4px solid #fbbf24;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

       #customAlert {
    position: fixed;
    bottom: 20px; /* Or top: 20px, as in the previous example */
    left: 50%;
    transform: translateX(-50%);
    background-color: #333;
    color: #fff;
    padding: 15px 25px;
    border-radius: 8px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    opacity: 0;
    transition: opacity 0.3s ease-in-out;
    z-index: 9999; /* This is the key change */
}

#customAlert.show {
    opacity: 1;
}

#customAlert.error {
    background-color: #e53e3e;
}

        .container { width: 100%; max-width: 600px; }
        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            position: fixed;
            top: 0;
            left: 0;
            background: #0f172a;
            padding: 1rem;
            z-index: 1000;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            box-sizing: border-box;
        }
        .navbar .logo {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .navbar .logo i { font-size: 1.5rem; color: #ef4444; }
        .navbar .logo .title {
            font-family: 'Pacifico', cursive;
            font-size: 1.8rem;
            color: #fbbf24;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        .navbar i.fa-bars { font-size: 1.5rem; cursor: pointer; color: #fff; }
        .navbar .menu { position: relative; }
        .menu-content {
            display: none;
            position: absolute;
            right: 0;
            top: 30px;
            background: rgba(30,41,59,0.95);
            border-radius: 0.5rem;
            min-width: 180px;
            padding: 0.5rem;
            z-index: 100;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            animation: fadeIn 0.3s ease-in-out;
        }
        .menu-content a, .menu-content button {
            display: flex;
            align-items: center;
            gap: 0.8rem;
            width: 100%;
            padding: 0.7rem;
            background: none;
            border: none;
            color: #fff;
            text-align: left;
            cursor: pointer;
            border-radius: 0.4rem;
            text-decoration: none;
        }
        .menu-content a:hover, .menu-content button:hover { background: rgba(255,255,255,0.1); }
        .menu-item-with-badge { position: relative; }
        .badge {
          position: absolute;
          top: 5px;
          right: 5px;
          background: red;
          color: #fff;
          border-radius: 50%;
          padding: 0.2rem 0.5rem;
          font-size: 0.7rem;
          min-width: 20px;
          text-align: center;
          border: 1px solid #0f172a;
          pointer-events: none;
          display: none;
        }
        .notification-icon-wrapper {
            position: relative;
            cursor: pointer;
        }
        .notification-icon-wrapper .badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ef4444;
            color: #fff;
            border-radius: 50%;
            padding: 0.3rem;
            font-size: 0.7rem;
            min-width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: none;
            border: 1px solid #0f172a;
            box-sizing: border-box;
            line-height: 1;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Post Creation Section */
        .create-post {
            background: rgba(255,255,255,0.08);
            backdrop-filter: blur(10px);
            border-radius: 1.5rem;
            padding: 1.5rem;
            margin-bottom: 2rem;
            width: 100%;
            box-sizing: border-box;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .create-post textarea {
            width: 96%;
            min-height: 65px;
            background: #1e293b;
            border: 1px solid #475569;
            border-radius: 1rem;
            padding: 1rem;
            color: #fff;
            font-size: 1rem;
            resize: vertical;
            margin-left:-10px;
        }
        .create-post .post-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
        }
        .create-post .file-input-wrapper {
            position: relative;
            display: inline-block;
        }
        .create-post .file-input-wrapper input[type="file"] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        .create-post .file-input-wrapper label {
            background: #475569;
            color: #fff;
            padding: 0.6rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: background 0.3s ease;
        }
        .create-post .file-input-wrapper label:hover { background: #334155; }
        .create-post button {
            background: #fbbf24;
            color: #0f172a;
            padding: 0.8rem 2rem;
            border: none;
            border-radius: 1rem;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            transition: background 0.3s ease;
        }
        .create-post button:hover { background: #f59e0b; }
        .post-preview {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.5rem;
            color: #94a3b8;
            font-size: 0.9rem;
        }
        .post-preview i { cursor: pointer; color: #ef4444; }


        /* Feed Post Styling */
        .feed { display: flex; flex-direction: column; gap: 2rem; width: 100%; }
        .post-card {
            background: rgba(255,255,255,0.08);
            backdrop-filter: blur(10px);
            border-radius: 1.5rem;
            padding: 1.5rem;
            box-sizing: border-box;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.2);
            transition: transform 0.2s ease-in-out;
        }
        .post-card:hover { transform: translateY(-5px); }
        .post-header { display: flex; align-items: center; gap: 0.8rem; margin-bottom: 1rem; }
        .post-header .post-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid #fbbf24; cursor: pointer;}
        .post-header .user-icon {
          width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid #fbbf24; cursor: pointer;
          display: flex; align-items: center; justify-content: center; font-size: 1.2rem; background: #475569;
        }
        .post-header .author-name { font-weight: bold; font-size: 1rem; color: #fbbf24; cursor: pointer; }
        .post-header .post-time { font-size: 0.8rem; color: #94a3b8; margin-left: auto; }
        .post-content {
            margin-bottom: 0rem;
            line-height: 1.5;
            white-space: pre-wrap;
            word-break: break-word;
            font-family: 'Bebas Neue', cursive;
            font-size: 0.2rem;
            color: #fbbf24;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
            letter-spacing: 1px;
        }
        .post-card .post-content p {
            font-size: 0.9rem;
            color: #fff;
            font-family: "Segoe UI", Arial, sans-serif;
            text-shadow: none;
            letter-spacing: normal;
        }
        .post-media-container {
            width: 100%;
            aspect-ratio: 16 / 9;
            position: relative;
            overflow: hidden;
            margin-top: 0.0rem;
            border-radius: 1rem;
            background: #1e293b;
        }
        .post-media-container img,
        .post-media-container video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
            cursor: pointer;
        }

        .post-actions-bar {
            display: flex;
            justify-content: space-around;
            border-top: 1px solid rgba(255,255,255,0.1);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding: 0.5rem 0;
            margin: 1rem 0;
        }
        .post-actions-bar button {
            background: none;
            border: none;
            color: #94a3b8;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            transition: background 0.3s ease, color 0.3s ease;
        }
        .post-actions-bar button:hover { background: rgba(255,255,255,0.1); color: #fff; }
        .post-actions-bar button.liked { color: #ef4444; }

        .comments-section { margin-top: 1rem; }
        .comment-input-wrapper { display: flex; gap: 0.5rem; margin-top: 1rem; }
        .comment-input-wrapper input {
            flex-grow: 1;
            background: #1e293b;
            border: 1px solid #475569;
            border-radius: 0.5rem;
            padding: 0.6rem;
            color: #fff;
            font-size: 0.9rem;
        }
        .comment-input-wrapper button {
            background: #fbbf24;
            color: #0f172a;
            border: none;
            border-radius: 0.5rem;
            padding: 0.6rem 1rem;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.9rem;
        }
        .comment-list { margin-top: 1rem; }
        .comment-item {
            display: flex;
            flex-direction: column;
            gap: 0.2rem;
            padding: 0.5rem 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .comment-item:last-child { border-bottom: none; }
        .comment-header {
            display: flex;
            align-items: baseline;
            gap: 0.5rem;
        }
        .comment-author { font-weight: bold; color: #fbbf24; cursor: pointer; font-size: 0.95rem; }
        .comment-text { flex-grow: 1; color: #ddd; line-height: 1.4; font-size: 0.9rem; }
        .comment-time { font-size: 0.7rem; color: #94a3b8; }

        /* Sponsored Ad Card */
        .ad-card {
            background: linear-gradient(45deg, #1f2a3e, #3a4b62);
            border-radius: 1.5rem;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-sizing: border-box;
            border: 1px dashed #fbbf24;
            position: relative;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.2);
            transition: transform 0.2s ease-in-out;
        }
        .ad-card:hover { transform: translateY(-5px); }
        .ad-card .ad-label {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: #fbbf24;
            color: #0f172a;
            padding: 0.2rem 0.6rem;
            border-radius: 0.3rem;
            font-size: 0.75rem;
            font-weight: bold;
            text-transform: uppercase;
        }
        .ad-card h2 { color: #fff; margin-top: 0; margin-bottom: 0.8rem; font-size: 1.3rem;}
        .ad-card p { font-size: 0.95rem; line-height: 1.5; color: #fff; margin-bottom: 1rem;}
        .ad-card img { max-width: 100%; border-radius: 0.5rem; margin-top: 0.8rem; display: block; }
        .ad-card .ad-link {
            display: inline-block;
            background: #ef4444;
            color: #fff;
            padding: 0.6rem 1.2rem;
            border-radius: 0.5rem;
            text-decoration: none;
            font-weight: bold;
            transition: background 0.3s ease;
        }
        .ad-card .ad-link:hover { background: #dc2626; }

        /* Placeholders */
        .placeholder-card {
          background: #334155;
          border-radius: 1.5rem;
          height: 250px;
          animation: pulse 1.5s infinite ease-in-out;
        }
        .placeholder-post-create {
          height: 150px;
          background: #334155;
          border-radius: 1.5rem;
          animation: pulse 1.5s infinite ease-in-out;
          margin-bottom: 1.5rem;
        }
        @keyframes pulse {
          0% { opacity: 0.6; }
          50% { opacity: 1; }
          100% { opacity: 0.6; }
        }

        /* NEW: Full Post Modal Styles */
        .full-post-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10001;
            animation: fadeIn 0.3s ease-in-out;
        }
        .full-post-modal .modal-content-wrapper {
            position: relative;
            width: 90%;
            max-width: 700px;
            background: #1e293b;
            border-radius: 1.5rem;
            padding: 2rem;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.4);
            max-height: 90vh;
            overflow-y: auto;
        }
        .close-modal-btn {
            position: absolute;
            top: 15px;
            right: 25px;
            font-size: 2.5rem;
            color: #fff;
            cursor: pointer;
            line-height: 1;
        }
        #modalPostContainer .post-card {
            background: none;
            box-shadow: none;
            padding: 0;
        }
        #modalPostContainer .post-actions-bar,
        #modalPostContainer .comments-section {
            padding: 1rem 0;
            border-top: none;
            border-bottom: none;
        }

     #floatingPostBtn {
    position: fixed;
    bottom: 95.0px !important; /* Add !important here */
    right: 30px;
    width: 60px;
    height: 60px;
    background: #fbbf24;
    color: #0f172a;
    border: none;
    border-radius: 50%;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2rem;
    cursor: pointer;
    z-index: 20000;
    transition: background 0.3s, box-shadow 0.3s;
}

        #floatingPostBtn:hover {
            background: #f59e0b;
            box-shadow: 0 8px 24px rgba(0,0,0,0.3);
        }
        /* Modal for Post Creation */
        #postModalOverlay {
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(15,23,42,0.85);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 20001;
        }
        #postModal {
            background: #1e293b;
            border-radius: 1.5rem;
            padding: 2rem 1.5rem;
            box-shadow: 0 8px 32px 0 rgba(0,0,0,0.3);
            max-width: 400px;
            width: 95vw;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            position: relative;
        }
        #closePostModalBtn {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 2rem;
            color: #fff;
            background: none;
            border: none;
            cursor: pointer;
        }
        @media (max-width: 600px) {
            #floatingPostBtn { bottom: 20px; right: 20px; width: 50px; height: 50px; font-size: 1.5rem; }
            #postModal { padding: 1.2rem 0.5rem; }
        }

    /* Floating Love Emoji Animation */
    @keyframes floatUp {
        0% {
            transform: translateY(0) scale(1) rotate(0deg);
            opacity: 0;
        }
        50% {
            opacity: 1;
        }
        100% {
            transform: translateY(-200px) scale(1.5) rotate(15deg);
            opacity: 0;
        }
    }
    .floating-emoji {
        position: absolute;
        font-size: 2rem;
        color: #ef4444;
        animation: floatUp 1s ease-out forwards;
        pointer-events: none;
        z-index: 50;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
    }
    .premium-badge {
        color: #FFD700;
        font-size: 1.5rem;
        cursor: pointer;
        margin-right: 1.5rem;
    }
    .free-badge {
        color: #A9A9A9;
        font-size: 1.5rem;
        cursor: pointer;
        margin-right: 1.5rem;
    }
    /* New search section styles */
    .search-section {
        background: rgba(255,255,255,0.08);
        backdrop-filter: blur(10px);
        border-radius: 1.5rem;
        padding: 1rem;
        margin-bottom: 2rem;
        width: 100%;
        box-sizing: border-box;
        box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.2);
        display: flex;
        align-items: center;
        gap: 1rem;
    }
    .search-section .user-avatar-small {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
        border: 2px solid #fbbf24;
        cursor: pointer;
    }
    .search-section .search-input {
        flex-grow: 1;
        background: #1e293b;
        border: 1px solid #475569;
        border-radius: 1rem;
        padding: 0.8rem 1rem;
        color: #fff;
        font-size: 1rem;
        max-width:170px;
    }
    .search-section .search-btn {
        background: #fbbf24;
        color: #0f172a;
        padding: 0.8rem 1rem;
        border: none;
        border-radius: 1rem;
        cursor: pointer;
        font-weight: bold;
        margin-left:;
        transition: background 0.3s ease;
    }
    .search-section .search-btn:hover {
        background: #f59e0b;
    }

    /* People You May Know - Glide Motion Container */
    .suggested-friends-container {
        overflow: hidden;
        padding-bottom: 1.5rem;
    }
    .suggested-friends-wrapper {
        display: flex;
        gap: 1rem;
        transition: transform 0.5s ease-in-out;
        will-change: transform;
    }
    .suggested-friends-item {
        flex-shrink: 0;
        width: 90px;
        cursor: pointer;
        background: rgba(255,255,255,0.08);
        border-radius: 1rem;
        padding: 1rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        text-align: center;
    }
    </style>
</head>
<body>
    <div id="loading-overlay" style="display:none;">
        <div class="spinner"></div>
        <span>Loading...</span>
    </div>

    
    <button id="floatingPostBtn" title="Create Post"><i class="fa-solid fa-plus"></i></button>
    <div id="postModalOverlay">
      <div id="postModal">
        <button id="closePostModalBtn" title="Close">&times;</button>
        <div class="create-post">
            <textarea id="postContent" placeholder="What's on your mind, Cupidian?"></textarea>
            <div class="post-actions">
                <div class="file-input-wrapper">
                    <input type="file" id="postMediaUpload" accept="image/*,video/mp4,video/quicktime">
                    <label for="postMediaUpload"><i class="fa-solid fa-paperclip"></i> Add Media</label>
                </div>
                <button id="submitPostBtn">Post</button>
            </div>
            <div id="postPreview" class="post-preview" style="display:none;">
                <span id="previewFileName"></span> <i class="fa-solid fa-times-circle" id="removeMedia"></i>
            </div>
        </div>
      </div>
    </div>

    <div class="container">
        <div class="navbar">
            <div class="logo">
                <i class="fa-solid fa-heart-circle-bolt"></i>
                <span class="title">Campus Cupid</span>
            </div>
            <div class="navbar-right-icons" style="display: flex; align-items: center; gap: 1rem;">
                <a href="premium.html" id="premiumBadgeLink" title="Go Premium">
                    <i class="fa-solid fa-gem free-badge" id="premiumBadge"></i>
                </a>
                <div class="notification-icon-wrapper" id="notificationIconWrapper">
                   <a href="notifications.html"><i class="fa-solid fa-bell" style="font-size: 1.5rem; color: #fff;"></i></a>
                    <span class="badge" id="notificationBadge">0</span>
                </div>
                <div class="menu">
                    <i class="fa-solid fa-bars" id="menuBtn"></i>
                    <div class="menu-content" id="menuContent">
                        <a href="profile.html"><i class="fa-solid fa-user"></i> My Profile</a>
                        <a href="findmatch.html"><i class="fa-solid fa-search"></i> Find Match</a>
                        <a href="chat.html"><i class="fa-solid fa-comments"></i> Chat</a>
                        <a href="notifications.html" class="menu-item-with-badge">
                            <i class="fa-solid fa-bell"></i> Notifications
                            <span class="badge" id="notificationBadgeMenu">0</span>
                        </a>
                        <a href="create_ad.html"><i class="fa-solid fa-bullhorn"></i> Post an Ad</a>
                        <a href="premium.html"><i class="fa-solid fa-gem"></i> Premium Membership</a>
                        
                        
                        <button id="logoutBtn"><i class="fa-solid fa-sign-out-alt"></i> Logout</button>
                    </div>
                </div>
            </div>
        </div><br>
        
        <div id="suggestedFriendsSection">
          <span style="color:#fbbf24; font-size:small; font-weight:bold;">People You May Know:</span>
          <div id="suggestedFriendsContainer" class="suggested-friends-container">
            <div id="suggestedFriendsWrapper" class="suggested-friends-wrapper">
              </div>
          </div>
        </div>
        
        <div class="search-section">
            <a href="profile.html" id="myProfileLink">
                <img id="myProfileAvatar" class="user-avatar-small" src="https://via.placeholder.com/40" alt="My Profile">
            </a>
            <input type="text" id="searchInput" class="search-input" placeholder="Search for users, posts, or comments...">
            <button id="searchBtn" class="search-btn"><i class="fa-solid fa-search"></i></button>
        </div>

        <div id="feed" class="feed">
            <div class="placeholder-card"></div>
            <div class="placeholder-card" style="height: 180px;"></div>
            <div class="placeholder-card"></div>
        </div>
    </div>

    <button id="installBtn" style="display: none;">Install App</button>

    <div id="mediaModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:9999; justify-content:center; align-items:center;">
        <img id="modalImage" style="max-width:90%; max-height:90%; object-fit:contain; display:none;">
        <video id="modalVideo" controls style="max-width:90%; max-height:100%; object-fit:contain; display:none;"></video>
        <span id="closeMediaModal" style="position:absolute; top:20px; right:30px; color:#fff; font-size:2rem; cursor:pointer;">&times;</span>
    </div>

    <div id="fullPostModal" class="full-post-modal" style="display:none;">
        <div class="modal-content-wrapper">
            <span id="closeFullPostModal" class="close-modal-btn">&times;</span>
            <div id="modalPostContainer">
                </div>
        </div>
    </div>
    <div class="custom-alert" id="customAlert"></div>

        <script>
        
// --- Supabase and Global Utility Initialization ---
const SUPABASE_URL = "https://vfbjwkfurleatfdrabdg.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZmYmp3a2Z1cmxlYXRmZHJhYmRnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc0MjAwNDIsImV4cCI6MjA3Mjk5NjA0Mn0.hguIfyynGc19tsSm9u66qy5IeUv40_mE8-JBjqnOQBE";
const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY); // Renamed to avoid redeclaration error


// --- Element Declarations (Grouping all document.getElementById calls) ---

// UI & Alert
const loadingOverlay = document.getElementById('loading-overlay');
const customAlert = document.getElementById('customAlert');
const installBtn = document.getElementById('installBtn');

// Navbar
const menuBtn = document.getElementById("menuBtn");
const menuContent = document.getElementById("menuContent");
const logoutBtn = document.getElementById("logoutBtn");

// Search & Profile Elements
const myProfileLink = document.getElementById('myProfileLink');
const myProfileAvatar = document.getElementById('myProfileAvatar');
const searchInput = document.getElementById('searchInput');
const searchBtn = document.getElementById('searchBtn');

// Feed Container
const feedContainer = document.getElementById('feed');

// Post Creation UI Elements
const floatingPostBtn = document.getElementById('floatingPostBtn');
const postModalOverlay = document.getElementById('postModalOverlay');
const closePostModalBtn = document.getElementById('closePostModalBtn');
const postContentInput = document.getElementById('postContent');
const postMediaUploadInput = document.getElementById('postMediaUpload');
const postPreview = document.getElementById('postPreview');
const previewFileName = document.getElementById('previewFileName'); 
const removeMediaBtn = document.getElementById('removeMedia');
const submitPostBtn = document.getElementById('submitPostBtn');

// Media Modal Elements
const mediaModal = document.getElementById('mediaModal');
const modalImage = document.getElementById('modalImage');
const modalVideo = document.getElementById('modalVideo');
const closeMediaModal = document.getElementById('closeMediaModal');

// Full Post Modal Elements
const fullPostModal = document.getElementById('fullPostModal');
const modalPostContainer = document.getElementById('modalPostContainer');
const closeFullPostModalBtn = document.getElementById('closeFullPostModal');

// "People You Know" Elements
const suggestedFriendsContainer = document.getElementById('suggestedFriendsContainer');
const suggestedFriendsWrapper = document.getElementById('suggestedFriendsWrapper');
const suggestedFriendsSection = document.getElementById('suggestedFriendsSection');


// --- Global State Variables ---
let isFFmpegLoaded = false;
let ffmpeg; // FFmpeg instance

let originalFeedHtml = feedContainer.innerHTML;
let allPostsAndComments = []; 
let currentFile = null;

// --- Pagination for Feed ---
let currentPage = 1;
const POSTS_PER_PAGE = 7;
const ADS_INTERVAL = 3;
let allPosts = [];
let allAds = [];
let isLoading = false;
let hasMorePosts = true;
let isPremiumUser = false;
let myProfileData = null;

// --- PWA Installation Prompt ---
let deferredPrompt;

window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    if (installBtn) {
        installBtn.style.display = 'block';
    }
});

if (installBtn) {
    installBtn.addEventListener('click', () => {
        installBtn.style.display = 'none';
        if (deferredPrompt) {
            deferredPrompt.prompt();
            deferredPrompt.userChoice.then((choiceResult) => {
                if (choiceResult.outcome === 'accepted') {
                    console.log('User accepted the install prompt');
                    showAlert("App installed successfully!", false);
                } else {
                    console.log('User dismissed the install prompt');
                    showAlert("Installation cancelled.", true);
                }
                deferredPrompt = null;
            });
        }
    });
}

// --- Register Service Worker ---
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js').then(registration => {
            console.log('Service Worker registered! Scope is:', registration.scope);
        }).catch(err => {
            console.log('Service Worker registration failed:', err);
        });
    });
}

// --- Loading Sign Functions ---
function showLoading() {
    loadingOverlay.style.display = 'flex';
}

function hideLoading() {
    loadingOverlay.style.display = 'none';
}

// --- Custom Alert Function ---
function showAlert(message, isError = false) {
    customAlert.textContent = message;
    customAlert.classList.remove('error');
    if (isError) {
        customAlert.classList.add('error');
    }
    customAlert.classList.add('show');
    setTimeout(() => {
        customAlert.classList.remove('show');
    }, 6000);
}

// --- Utility Functions (TimeAgo, shuffleArray, fetchNotifications, loadFFmpeg) ---
function timeAgo(dateString) {
    const now = new Date();
    const past = new Date(dateString);
    const seconds = Math.floor((now - past) / 1000);

    let interval = seconds / 31536000;
    if (interval > 1) return Math.floor(interval) + " years ago";
    interval = seconds / 2592000;
    if (interval > 1) return Math.floor(interval) + " months ago";
    interval = seconds / 86400;
    if (interval > 1) return Math.floor(interval) + " days ago";
    interval = seconds / 3600;
    if (interval > 1) return Math.floor(interval) + " hours ago";
    interval = seconds / 60;
    if (interval > 1) return Math.floor(interval) + " minutes ago";
    return Math.floor(seconds) + " seconds ago";
}

// Function to shuffle an array (Fisher-Yates algorithm)
function shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
}

async function fetchNotifications() {
    const { data: { user } } = await supabaseClient.auth.getUser();
    if (!user) return;

    const { count, error } = await supabaseClient
        .from('notifications')
        .select('*', { count: 'exact', head: true })
        .eq('recipient_id', user.id)
        .eq('read_status', false);

    if (error) {
        console.error("Error fetching notifications:", error);
        return;
    }

    const mainBadge = document.getElementById('notificationBadge');
    const menuBadge = document.getElementById('notificationBadgeMenu');
    if (count > 0) {
        mainBadge.textContent = count;
        menuBadge.textContent = count;
        mainBadge.style.display = 'flex';
        menuBadge.style.display = 'flex';
    } else {
        mainBadge.style.display = 'none';
        menuBadge.style.display = 'none';
    }
}

async function loadFFmpeg() {
    if (isFFmpegLoaded) return;
    try {
        const { createFFmpeg, fetchFile } = FFmpeg;
        ffmpeg = createFFmpeg({ log: false });
        await ffmpeg.load();
        isFFmpegLoaded = true;
        console.log('FFmpeg loaded successfully');
    } catch (e) {
        console.error("Failed to load FFmpeg:", e);
        showAlert("Failed to load video processor. Video features will be disabled.", true);
    }
}

// --- Menu Toggle ---
document.getElementById("menuBtn").addEventListener("click", () => {
    const menu = document.getElementById("menuContent");
    menu.style.display = menu.style.display === "block" ? "none" : "block";
});

// --- Logout Functionality ---
document.getElementById("logoutBtn").addEventListener("click", async () => {
    await supabaseClient.auth.signOut();
    window.location.href = "index.html";
});

// --- Post Media Upload Preview and Removal ---
postMediaUploadInput.addEventListener('change', (event) => {
    const file = event.target.files[0];
    if (file) {
        currentFile = file;
        previewFileName.textContent = file.name;
        postPreview.style.display = 'flex';
    } else {
        currentFile = null;
        postPreview.style.display = 'none';
    }
});

removeMediaBtn.addEventListener('click', () => {
    currentFile = null;
    postMediaUploadInput.value = '';
    postPreview.style.display = 'none';
});

// Function to trim video to 50 seconds using FFmpeg.js
async function trimVideo(file) {
    if (!isFFmpegLoaded) {
      showAlert("Preparing video trimmer...", false);
      await loadFFmpeg();
    }
    
    showAlert("Processing video... this might take a moment.", false);

    const inputFileName = 'input.mp4';
    const outputFileName = 'output.mp4';
    const durationLimit = 50;

    ffmpeg.FS('writeFile', inputFileName, await fetchFile(file));

    await ffmpeg.run(
        '-i', inputFileName,
        '-ss', '0',
        '-t', `${durationLimit}`,
        '-c', 'copy',
        outputFileName
    );

    const data = ffmpeg.FS('readFile', outputFileName);
    const trimmedBlob = new Blob([data.buffer], { type: 'video/mp4' });

    ffmpeg.FS('unlink', inputFileName);
    ffmpeg.FS('unlink', outputFileName);

    return trimmedBlob;
}

// --- Create Post Functionality with restrictions ---
submitPostBtn.addEventListener('click', async () => {
    const postContent = postContentInput.value.trim();
    if (!postContent && !currentFile) {
        showAlert("Please write something or add media to your post.", true);
        return;
    }

    submitPostBtn.disabled = true;
    submitPostBtn.textContent = "Posting...";

    try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) {
            showAlert("You must be logged in to post.", true);
            window.location.href = "index.html";
            return;
        }

        // --- Post Count Restriction for non-premium users
        if (!isPremiumUser) {
            const twentyFourHoursAgo = new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString();
            const { count, error } = await supabaseClient
                .from('posts')
                .select('*', { count: 'exact', head: true })
                .eq('author_id', user.id)
                .gte('created_at', twentyFourHoursAgo);

            if (error) throw new Error("Failed to check post count.");
            const MAX_POSTS_PER_DAY = 1;
            if (count >= MAX_POSTS_PER_DAY) {
                showAlert(`Free users can only make ${MAX_POSTS_PER_DAY} posts every 24 hours. Please upgrade to premium to post more.`, true);
                submitPostBtn.disabled = false;
                submitPostBtn.textContent = "Post";
                return;
            }
        }
        
        let imageUrl = null;
        let videoUrl = null;

        if (currentFile) {
            const fileType = currentFile.type.startsWith('image/') ? 'images' : 'videos';
            const fileExt = currentFile.name.split('.').pop();
            const fileName = `${user.id}/${Date.now()}.${fileExt}`;
            const filePath = `post_media/${fileName}`;

            let fileToUpload = currentFile;
            if (fileType === 'images') {
                fileToUpload = await new Promise((resolve, reject) => {
                    new Compressor(currentFile, {
                        quality: 0.5,
                        maxWidth: 1200,
                        maxHeight: 1200,
                        success: resolve,
                        error: reject,
                    });
                });
            } else if (fileType === 'videos') {
                if (!isPremiumUser) {
                    showAlert("Only premium users can post videos.", true);
                    submitPostBtn.disabled = false;
                    submitPostBtn.textContent = "Post";
                    return;
                }

                const videoElement = document.createElement('video');
                videoElement.preload = 'metadata';
                videoElement.src = URL.createObjectURL(currentFile);

                const duration = await new Promise((resolve) => {
                    videoElement.onloadedmetadata = () => {
                        resolve(videoElement.duration);
                        URL.revokeObjectURL(videoElement.src);
                    };
                });

                if (duration > 50) {
                    showAlert("Trimming video to 50 seconds...", false);
                    fileToUpload = await trimVideo(currentFile);
                }
            }

            const { data: uploadData, error: uploadError } = await supabaseClient.storage
                .from('post_media')
                .upload(filePath, fileToUpload, { upsert: false });

            if (uploadError) throw new Error("Media upload failed: " + uploadError.message);

            const { data: publicUrlData } = supabaseClient.storage.from('post_media').getPublicUrl(filePath);
            if (fileType === 'images') {
                imageUrl = publicUrlData.publicUrl;
            } else {
                videoUrl = publicUrlData.publicUrl;
            }
        }

        const { error: postError } = await supabaseClient.from('posts').insert({
            author_id: user.id,
            content: postContent,
            image_url: imageUrl,
            video_url: videoUrl,
        });

        if (postError) throw new Error("Failed to create post: " + postError.message);

        showAlert("Post created successfully!");
        postContentInput.value = '';
        removeMediaBtn.click();
        postModalOverlay.style.display = 'none';
        loadFeed();

    } catch (error) {
        console.error("Error creating post:", error);
        showAlert("Failed to create post: " + error.message, true);
    } finally {
        submitPostBtn.disabled = false;
        submitPostBtn.textContent = "Post";
    }
});


// --- Render Post Function ---
async function renderPost(post, currentUserId, userProfilesMap, likesMap, commentsMap) {
    const postCard = document.createElement('div');
    postCard.className = 'post-card';
    postCard.id = `post-${post.id}`;

    const authorProfile = userProfilesMap[post.author_id] || { full_name: "Unknown User", avatar_url: "" };
    const avatarSrc = authorProfile.avatar_url ? authorProfile.avatar_url : '';

    const likesArray = likesMap[post.id] || [];
    const likesCount = likesArray.length;
    const isLikedByUser = likesArray.includes(currentUserId);

    const commentsCount = commentsMap[post.id] || 0;

    let mediaHTML = '';
    if (post.image_url) {
        mediaHTML = `<div class="post-media-container"><img data-src="${post.image_url}" alt="Post Image" class="lazy-load" data-media-url="${post.image_url}" data-media-type="image"></div>`;
    } else if (post.video_url) {
        mediaHTML = `<div class="post-media-container"><video controls data-src="${post.video_url}" class="lazy-load" data-media-url="${post.video_url}" data-media-type="video"></video></div>`;
    }

    postCard.innerHTML = `
        <div class="post-header">
            <a href="profile.html?id=${post.author_id}" class="post-avatar-link">
                ${avatarSrc ? `<img src="${avatarSrc}" alt="Author Avatar" class="post-avatar">` : `<div class="user-icon"><i class="fa-solid fa-user"></i></div>`}
            </a>
            <a href="profile.html?id=${post.author_id}" class="author-name">${authorProfile.full_name}</a>
            <span class="post-time">${timeAgo(post.created_at)}</span>
        </div>
        <div class="post-content">
            <p>${post.content || ''}</p>
            ${mediaHTML}
        </div>
        <div class="post-actions-bar">
            <button class="like-btn ${isLikedByUser ? 'liked' : ''}" data-post-id="${post.id}">
                <i class="fa-solid fa-heart"></i> <span class="like-count">${likesCount}</span> Likes
            </button>
            <button class="comment-btn" data-post-id="${post.id}">
                <i class="fa-solid fa-comment"></i> <span class="comment-count">${commentsCount}</span> Comments
            </button>
        </div>
    `;
    feedContainer.appendChild(postCard);

    const mediaElement = postCard.querySelector('img[data-media-url], video[data-media-url]');
    if (mediaElement) {
        mediaElement.addEventListener('click', (e) => {
            const mediaUrl = e.target.dataset.mediaUrl;
            const mediaType = e.target.dataset.mediaType;
            modalImage.style.display = 'none';
            modalVideo.style.display = 'none';

            if (mediaType === 'image') {
                modalImage.src = mediaUrl;
                modalImage.style.display = 'block';
            } else if (mediaType === 'video') {
                modalVideo.src = mediaUrl;
                modalVideo.style.display = 'block';
            }
            mediaModal.style.display = 'flex';
        });
    }

    postCard.querySelector('.like-btn').addEventListener('click', async (e) => {
        e.preventDefault();
        const postId = e.currentTarget.dataset.postId;
        await handleLike(postId, e.currentTarget);
    });

    postCard.querySelector('.comment-btn').addEventListener('click', async (e) => {
        e.preventDefault();
        const postId = e.currentTarget.dataset.postId;
        const { data: comments } = await supabaseClient
            .from('comments')
            .select(`
                id,
                comment_text,
                created_at,
                author_id,
                profiles(full_name, avatar_url)
            `)
            .eq('post_id', postId)
            .order('created_at', { ascending: true });

        const commentsHTML = comments && comments.length > 0 ? comments.map(comment => `
            <div class="comment-item">
                <div class="comment-header">
                    <a href="profile.html?id=${comment.author_id}" class="comment-author">${comment.profiles.full_name || 'Unknown User'}</a>
                    <span class="comment-time">${timeAgo(comment.created_at)}</span>
                </div>
                <span class="comment-text">${comment.comment_text}</span>
            </div>
        `).join('') : `<p id="no-comments-msg-${postId}" style="font-size:0.9rem; color:#94a3b8; text-align: center;">No comments yet. Be the first!</p>`;

        const postCardContent = postCard.innerHTML;
        const modalContent = `
            <div class="post-card">
                ${postCardContent}
                <div class="comments-section" id="comments-section-${postId}">
                    <div class="comment-list" id="comment-list-${postId}">
                        ${commentsHTML}
                    </div>
                    <div class="comment-input-wrapper">
                        <input type="text" placeholder="Add a comment..." id="comment-input-${postId}">
                        <button class="submit-comment-btn" data-post-id="${postId}">Post</button>
                    </div>
                </div>
            </div>
        `;
        openFullPostModal(modalContent);

        const modalLikeBtn = modalPostContainer.querySelector('.like-btn');
        const modalCommentInput = modalPostContainer.querySelector(`#comment-input-${postId}`);
        const modalCommentSubmitBtn = modalPostContainer.querySelector('.submit-comment-btn');

        if (modalLikeBtn) {
            modalLikeBtn.addEventListener('click', (e) => handleLike(postId, e.currentTarget));
        }
        if (modalCommentSubmitBtn) {
            modalCommentSubmitBtn.addEventListener('click', async () => {
                const commentText = modalCommentInput.value.trim();
                if (commentText) {
                    await handleComment(postId, commentText, true);
                    modalCommentInput.value = '';
                }
            });
        }
        const modalMediaElement = modalPostContainer.querySelector('img[data-media-url], video[data-media-url]');
         if (modalMediaElement) {
            modalMediaElement.addEventListener('click', (e) => {
                const mediaUrl = e.target.dataset.mediaUrl;
                const mediaType = e.target.dataset.mediaType;
                modalImage.style.display = 'none';
                modalVideo.style.display = 'none';

                if (mediaType === 'image') {
                    modalImage.src = mediaUrl;
                    modalImage.style.display = 'block';
                } else if (mediaType === 'video') {
                    modalVideo.src = mediaUrl;
                    modalVideo.style.display = 'block';
                }
                mediaModal.style.display = 'flex';
            });
        }
    });
}

// --- Render Ad Function ---
function renderAd(ad) {
    const adCard = document.createElement('div');
    adCard.className = 'ad-card';
    adCard.innerHTML = `
        <span class="ad-label">Sponsored</span>
        <h2>${ad.title}</h2>
        <p>${ad.content || ''}</p>
        ${ad.image_url ? `<div class="post-media-container"><img data-src="${ad.image_url}" alt="Ad Image" class="lazy-load"></div>` : ''}
        ${ad.target_url ? `<a href="${ad.target_url}" target="_blank" class="ad-link">Learn More <i class="fa-solid fa-arrow-up-right-from-square"></i></a>` : ''}
    `;
    feedContainer.appendChild(adCard);
}

// --- Full Post Modal Functions ---
function openFullPostModal(postCardHTML) {
    modalPostContainer.innerHTML = postCardHTML;
    fullPostModal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
}

closeFullPostModalBtn.addEventListener('click', () => {
    fullPostModal.style.display = 'none';
    modalPostContainer.innerHTML = '';
    document.body.style.overflow = '';
});

// --- Glide motion for suggested friends ---
let glideInterval;
let isDragging = false;
let startX;
let scrollLeft;
const GLIDE_SPEED = 4000; // in milliseconds

function startGlide() {
    if (suggestedFriendsWrapper.scrollWidth <= suggestedFriendsContainer.clientWidth) return;
    glideInterval = setInterval(() => {
        let currentScroll = suggestedFriendsContainer.scrollLeft;
        let maxScroll = suggestedFriendsWrapper.scrollWidth - suggestedFriendsContainer.clientWidth;
        let newScroll = currentScroll + 90; // Move by one card width

        if (newScroll >= maxScroll) {
            newScroll = 0;
        }
        suggestedFriendsContainer.scrollTo({
            left: newScroll,
            behavior: 'smooth'
        });
    }, GLIDE_SPEED);
}

function stopGlide() {
    clearInterval(glideInterval);
}

suggestedFriendsContainer.addEventListener('mouseenter', stopGlide);
suggestedFriendsContainer.addEventListener('mouseleave', startGlide);
suggestedFriendsContainer.addEventListener('mousedown', (e) => {
    isDragging = true;
    startX = e.pageX - suggestedFriendsContainer.offsetLeft;
    scrollLeft = suggestedFriendsContainer.scrollLeft;
    suggestedFriendsContainer.style.cursor = 'grabbing';
    stopGlide();
});
suggestedFriendsContainer.addEventListener('mouseleave', () => {
    if (isDragging) {
        isDragging = false;
        suggestedFriendsContainer.style.cursor = 'grab';
        startGlide();
    }
});
suggestedFriendsContainer.addEventListener('mouseup', () => {
    isDragging = false;
    suggestedFriendsContainer.style.cursor = 'grab';
    startGlide();
});
suggestedFriendsContainer.addEventListener('mousemove', (e) => {
    if (!isDragging) return;
    e.preventDefault();
    const x = e.pageX - suggestedFriendsContainer.offsetLeft;
    const walk = (x - startX) * 2;
    suggestedFriendsContainer.scrollLeft = scrollLeft - walk;
});
suggestedFriendsContainer.addEventListener('touchstart', (e) => {
    stopGlide();
    isDragging = true;
    startX = e.touches[0].pageX - suggestedFriendsContainer.offsetLeft;
    scrollLeft = suggestedFriendsContainer.scrollLeft;
}, { passive: true });
suggestedFriendsContainer.addEventListener('touchend', () => {
    isDragging = false;
    startGlide();
});
suggestedFriendsContainer.addEventListener('touchmove', (e) => {
    if (!isDragging) return;
    const x = e.touches[0].pageX - suggestedFriendsContainer.offsetLeft;
    const walk = (x - startX) * 2;
    suggestedFriendsContainer.scrollLeft = scrollLeft - walk;
}, { passive: false });


// REVISED: renderSuggestedFriends function for randomization
async function renderSuggestedFriends(currentUserId) {
    const { data: friends } = await supabaseClient
        .from('friend_requests')
        .select('sender_id,receiver_id')
        .or(`sender_id.eq.${currentUserId},receiver_id.eq.${currentUserId}`)
        .eq('status', 'accepted');
    const friendIds = new Set([currentUserId]);
    if (friends) {
        friends.forEach(f => {
            if (f.sender_id !== currentUserId) friendIds.add(f.sender_id);
            if (f.receiver_id !== currentUserId) friendIds.add(f.receiver_id);
        });
    }

    // Fetch a larger pool of non-friends (e.g., 100)
    const { data: profiles } = await supabaseClient
        .from('profiles')
        .select('user_id,full_name,avatar_url')
        .not('user_id', 'in', `(${Array.from(friendIds).join(',')})`)
        .limit(100); // <-- Increased limit for randomization pool

    let suggestedProfiles = profiles || [];
    
    // Shuffle the entire fetched list for randomness
    shuffleArray(suggestedProfiles);

    // Take only the top 10 after shuffling
    suggestedProfiles = suggestedProfiles.slice(0, 10);
    
    suggestedFriendsWrapper.innerHTML = '';
    if (suggestedProfiles.length > 0) {
        suggestedProfiles.forEach(profile => {
            const item = document.createElement('div');
            item.className = 'suggested-friends-item';
            item.onclick = () => window.location.href = `profile.html?id=${profile.user_id}`;
            item.innerHTML = `
                ${profile.avatar_url
                    ? `<img src="${profile.avatar_url}" style="width:60px;height:60px;border-radius:50%;object-fit:cover;margin-bottom:0.5rem;">`
                    : `<div style="width:60px;height:60px;border-radius:50%;background:#475569;display:flex;align-items:center;justify-content:center;color:#fff;font-size:2rem;margin-bottom:0.5rem;"><i class="fa-solid fa-user"></i></div>`}
                <span style="color:#fff;font-size:1rem;text-align:center;white-space:normal;width:100%;">${profile.full_name}</span>
            `;
            suggestedFriendsWrapper.appendChild(item);
        });
        suggestedFriendsSection.style.display = 'block';
        startGlide();
    } else {
        suggestedFriendsSection.style.display = 'none';
    }
}

// This is the complete, revised loadFeed function.
async function loadFeed(page = 1, append = false, searchTerm = null) {
    if (isLoading) return;
    isLoading = true;
    showLoading();

    const loadMoreBtn = document.getElementById('loadMoreBtn');
    if (loadMoreBtn) loadMoreBtn.style.display = 'none';

    if (!append) {
        feedContainer.innerHTML = '';
        currentPage = 1;
        hasMorePosts = true;
    }

    const { data: { user } } = await supabaseClient.auth.getUser();
    if (!user) {
        window.location.href = "index.html";
        return;
    }
    
    // Fetch user profile and check premium status
    const { data: profile } = await supabaseClient
        .from('profiles')
        .select('is_premium, avatar_url')
        .eq('user_id', user.id)
        .single();
    if (profile) {
        isPremiumUser = profile.is_premium;
        myProfileAvatar.src = profile.avatar_url || 'https://via.placeholder.com/40';
        myProfileLink.href = `profile.html?id=${user.id}`;
        const premiumBadge = document.getElementById('premiumBadge');
        premiumBadge.className = isPremiumUser ? 'fa-solid fa-gem premium-badge' : 'fa-solid fa-star free-badge';
    }
    fetchNotifications();

    if (!searchTerm) {
        // NOTE: This section is inefficient and downloads ALL posts. 
        // A better approach is to use .range() on the Supabase query for actual pagination.
        const { data: posts, error: postsError } = await supabaseClient
            .from('posts')
            .select('*')
            .order('created_at', { ascending: false });
        if (postsError) {
            console.error("Error fetching posts:", postsError.message);
            feedContainer.innerHTML = `<p style="text-align: center; color: #ef4444;">Error loading posts.</p>`;
            hideLoading();
            isLoading = false;
            return;
        }
        allPosts = posts || [];
        const { data: ads } = await supabaseClient.from('ads').select('*').eq('is_active', true).order('created_at', { ascending: false });
        allAds = ads || [];
        renderSuggestedFriends(user.id);
        suggestedFriendsSection.style.display = 'block';
    } else {
        const searchQuery = `%${searchTerm.toLowerCase()}%`;
        
        // Execute all three search queries in parallel to find matching post IDs
        const [postsWithContent, commentsFound, profilesFound] = await Promise.all([
            supabaseClient.from('posts').select('id').ilike('content', searchQuery),
            supabaseClient.from('comments').select('post_id').ilike('comment_text', searchQuery),
            supabaseClient.from('profiles').select('user_id').ilike('full_name', searchQuery),
        ]);

        const postIds = new Set();
        if (postsWithContent.data) postsWithContent.data.forEach(p => postIds.add(p.id));
        if (commentsFound.data) commentsFound.data.forEach(c => postIds.add(c.post_id));
        
        // Get posts from users with matching names
        if (profilesFound.data) {
            const userIds = profilesFound.data.map(p => p.user_id);
            if (userIds.length > 0) {
                const { data: userPosts } = await supabaseClient.from('posts').select('id').in('author_id', userIds);
                if (userPosts) userPosts.forEach(p => postIds.add(p.id));
            }
        }
        
        // Fetch full posts for the unique IDs found
        const { data: posts, error: fetchPostsError } = await supabaseClient
            .from('posts')
            .select('*')
            .in('id', Array.from(postIds))
            .order('created_at', { ascending: false });
        
        if (fetchPostsError) {
             console.error("Error fetching search results:", fetchPostsError.message);
             feedContainer.innerHTML = `<p style="text-align: center; color: #ef4444;">Error fetching search results.</p>`;
             hideLoading();
             isLoading = false;
             return;
        }
        allPosts = posts || [];
        allAds = []; // Do not show ads during search
        suggestedFriendsSection.style.display = 'none';
    }
    
    // The rest of the function remains the same, but it now uses the correctly populated allPosts array
    const start = (page - 1) * POSTS_PER_PAGE;
    const end = start + POSTS_PER_PAGE;
    const postsToShow = allPosts.slice(start, end);
    hasMorePosts = allPosts.length > end;

    const uniqueUserIds = new Set();
    postsToShow.forEach(post => uniqueUserIds.add(post.author_id));
    const { data: profiles, error: profilesError } = await supabaseClient
        .from('profiles')
        .select('user_id, full_name, avatar_url')
        .in('user_id', Array.from(uniqueUserIds));
    const userProfilesMap = {};
    if (profiles) profiles.forEach(profile => { userProfilesMap[profile.user_id] = profile; });

    const likes = [];
    const comments = [];
    if (postsToShow.length > 0) {
        const postIds = postsToShow.map(p => p.id);
        const [likesRes, commentsRes] = await Promise.all([
            supabaseClient.from('likes').select('*').in('post_id', postIds),
            supabaseClient.from('comments').select('post_id').in('post_id', postIds)
        ]);
        if (likesRes.data) likes.push(...likesRes.data);
        if (commentsRes.data) comments.push(...commentsRes.data);
    }
    
    const likesMap = {};
    likes.forEach(like => {
        if (!likesMap[like.post_id]) likesMap[like.post_id] = [];
        likesMap[like.post_id].push(like.user_id);
    });
    const commentsMap = {};
    comments.forEach(comment => {
        commentsMap[comment.post_id] = (commentsMap[comment.post_id] || 0) + 1;
    });

    let adIndex = 0;
    const feedContent = [];
    postsToShow.forEach((post, index) => {
        feedContent.push({ type: 'post', data: post });
        if (!searchTerm && allAds.length > 0 && (index + 1) % ADS_INTERVAL === 0) {
            feedContent.push({ type: 'ad', data: allAds[adIndex % allAds.length] });
            adIndex++;
        }
    });

    feedContent.forEach(item => {
        if (item.type === 'post') {
            renderPost(item.data, user.id, userProfilesMap, likesMap, commentsMap);
        } else if (item.type === 'ad') {
            renderAd(item.data);
        }
    });

    if (hasMorePosts) {
        let loadMoreBtn = document.getElementById('loadMoreBtn');
        if (!loadMoreBtn) {
            loadMoreBtn = document.createElement('button');
            loadMoreBtn.id = 'loadMoreBtn';
            loadMoreBtn.textContent = 'Load More';
            loadMoreBtn.style.cssText = `
                display: block;
                margin: 2rem auto;
                background: #fbbf24;
                color: #0f172a;
                font-weight: bold;
                border: none;
                border-radius: 1rem;
                padding: 1rem 2rem;
                cursor: pointer;
            `;
            feedContainer.appendChild(loadMoreBtn);
            loadMoreBtn.addEventListener('click', () => {
                currentPage++;
                loadFeed(currentPage, true, searchTerm);
            });
        } else {
            feedContainer.appendChild(loadMoreBtn);
        }
        loadMoreBtn.style.display = 'block';
    } else {
        const btn = document.getElementById('loadMoreBtn');
        if (btn) btn.remove();
    }
    
    if (postsToShow.length === 0) {
        feedContainer.innerHTML = '<p style="text-align: center; color: #94a3b8;">No results found.</p>';
    }

    lazyLoadImages();
    hideLoading();
    isLoading = false;
}


// --- Like / Unlike Post Handler ---
async function handleLike(postId, buttonElement) {
    const { data: { user } } = await supabaseClient.auth.getUser();
    if (!user) { showAlert("Please log in to like posts.", true); return; }

    const { data: existingLike, error: checkError } = await supabaseClient
        .from('likes')
        .select('id')
        .eq('post_id', postId)
        .eq('user_id', user.id)
        .single();

    if (checkError && checkError.code !== 'PGRST116') {
        console.error("Error checking like status:", checkError.message);
        return;
    }

    let currentLikes = parseInt(buttonElement.querySelector('.like-count').textContent);

    if (existingLike) {
        const { error } = await supabaseClient
            .from('likes')
            .delete()
            .eq('id', existingLike.id);
        if (error) { console.error("Error unliking post:", error.message); return; }
        buttonElement.classList.remove('liked');
        buttonElement.querySelector('.like-count').textContent = currentLikes - 1;
    } else {
        const { error } = await supabaseClient
            .from('likes')
            .insert({ post_id: postId, user_id: user.id });
        if (error) { console.error("Error liking post:", error.message); return; }
        buttonElement.classList.add('liked');
        buttonElement.querySelector('.like-count').textContent = currentLikes + 1;

        const postCard = buttonElement.closest('.post-card');
        const heartIcon = buttonElement.querySelector('.fa-heart');
        if (postCard && heartIcon) {
            const emoji = document.createElement('div');
            emoji.className = 'floating-emoji';
            emoji.textContent = '💕';

            const rect = heartIcon.getBoundingClientRect();
            emoji.style.left = `${rect.left + rect.width / 2}px`;
            emoji.style.top = `${rect.top}px`;

            document.body.appendChild(emoji);

            setTimeout(() => {
                emoji.remove();
            }, 1000);
        }
    }
}

// --- Handle Comment Function with restrictions ---
async function handleComment(postId, commentText, isModal = false) {
    const { data: { user } } = await supabaseClient.auth.getUser();
    if (!user) { showAlert("Please log in to comment.", true); return; }

    // Comment count restriction for non-premium users
    if (!isPremiumUser) {
        const { count, error } = await supabaseClient
            .from('comments')
            .select('*', { count: 'exact', head: true })
            .eq('post_id', postId)
            .eq('author_id', user.id);
        
        if (error) { console.error("Error checking comment count:", error.message); return; }

        const MAX_COMMENTS_PER_POST = 1;
        if (count >= MAX_COMMENTS_PER_POST) {
            showAlert(`Free users cannot upload more than ${MAX_COMMENTS_PER_POST} comments to a single post. Please upgrade to premium to comment more.`, true);
            return;
        }
    }
    
    const { data: newComment, error } = await supabaseClient.from('comments').insert({
        post_id: postId,
        author_id: user.id,
        comment_text: commentText,
    }).select('*, profiles(full_name, avatar_url)').single();

    if (error) {
        console.error("Error posting comment:", error.message);
        showAlert("Failed to post comment: " + error.message, true);
    } else {
        console.log("Comment posted successfully!");

        if (isModal) {
            const commentList = document.getElementById(`comment-list-${postId}`);
            const noCommentsMsg = document.getElementById(`no-comments-msg-${postId}`);

            if (noCommentsMsg) {
                noCommentsMsg.remove();
            }

            const newCommentItem = document.createElement('div');
            newCommentItem.className = 'comment-item';
            newCommentItem.innerHTML = `
                <div class="comment-header">
                    <a href="profile.html?id=${newComment.author_id}" class="comment-author">${newComment.profiles.full_name || 'Unknown User'}</a>
                    <span class="comment-time">${timeAgo(newComment.created_at)}</span>
                </div>
                <span class="comment-text">${newComment.comment_text}</span>
            `;
            commentList.appendChild(newCommentItem);

            const mainFeedPost = document.getElementById(`post-${postId}`);
            if (mainFeedPost) {
                const commentCountElement = mainFeedPost.querySelector('.comment-count');
                let currentCount = parseInt(commentCountElement.textContent);
                commentCountElement.textContent = currentCount + 1;
            }
        }
    }
}

// --- Media Modal Closing ---
closeMediaModal.addEventListener('click', () => {
    mediaModal.style.display = 'none';
    modalImage.src = '';
    modalVideo.src = '';
    modalVideo.pause();
});

// --- Lazy Loading Functionality ---
function lazyLoadImages() {
    const lazyImages = document.querySelectorAll('img.lazy-load, video.lazy-load');
    const observer = new IntersectionObserver((entries, observer) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const mediaElement = entry.target;
                const dataSrc = mediaElement.getAttribute('data-src');
                if (dataSrc) {
                    mediaElement.src = dataSrc;
                    mediaElement.removeAttribute('data-src');
                    mediaElement.classList.remove('lazy-load');
                    observer.unobserve(mediaElement);
                }
            }
        });
    }, {
        rootMargin: '0px 0px 200px 0px'
    });
    lazyImages.forEach(image => {
        observer.observe(image);
    });
}

// --- Search Functionality ---
searchBtn.addEventListener('click', () => {
    const searchTerm = searchInput.value.trim();
    if (searchTerm) {
        loadFeed(1, false, searchTerm);
    } else {
        loadFeed(); // Reload feed if search is cleared
    }
});

searchInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        searchBtn.click();
    }
});

// --- Initial Load & App Logic ---
document.addEventListener('DOMContentLoaded', async () => {
    // 1. Check for a session immediately to decide whether to proceed or redirect.
    const { data: { session } } = await supabaseClient.auth.getSession();
    
    if (session) {
        // If a session exists, load the feed and suggested friends.
        // renderSuggestedFriends is now called inside loadFeed when no search term is present.
        await loadFeed(); 
    } else {
        // If no session, redirect to the login/signup page.
        window.location.href = "index.html";
        return;
    }
});


// --- Modal UI Logic ---
floatingPostBtn.addEventListener('click', () => {
    postModalOverlay.style.display = 'flex';
    setTimeout(() => {
        document.getElementById('postContent').focus();
    }, 100);
});

closePostModalBtn.addEventListener('click', () => {
    postModalOverlay.style.display = 'none';
});

window.addEventListener('click', (e) => {
    if (e.target === postModalOverlay) {
        postModalOverlay.style.display = 'none';
    }
});

</script>

            
</body>
</html>
